<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>JetPack部分使用心得 | Migu'Blog|迷毂</title><meta name="author" content="migu"><meta name="copyright" content="migu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="[TOC] ViewModel​		ViewModel是在生命周期感知型组件中，ViewModel(ViewModel 概览  | Android 开发者  | Android Developers) 类是一种业务逻辑或屏幕级状态容器。它用于将状态公开给界面，以及封装相关的业务逻辑。 它的主要优点是，它可以缓存状态，并可在配置更改后持久保留相应状态。这意味着在 activity 之间导航时或进行配">
<meta property="og:type" content="article">
<meta property="og:title" content="JetPack部分使用心得">
<meta property="og:url" content="https://migu316.github.io/2024/01/09/Android/JetPack/index.html">
<meta property="og:site_name" content="Migu&#39;Blog|迷毂">
<meta property="og:description" content="[TOC] ViewModel​		ViewModel是在生命周期感知型组件中，ViewModel(ViewModel 概览  | Android 开发者  | Android Developers) 类是一种业务逻辑或屏幕级状态容器。它用于将状态公开给界面，以及封装相关的业务逻辑。 它的主要优点是，它可以缓存状态，并可在配置更改后持久保留相应状态。这意味着在 activity 之间导航时或进行配">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lc-zp9lzzl0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png">
<meta property="article:published_time" content="2024-01-09T07:38:47.892Z">
<meta property="article:modified_time" content="2024-04-02T07:34:30.909Z">
<meta property="article:author" content="migu">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="JecPack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lc-zp9lzzl0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png"><link rel="shortcut icon" href="http://lc-zp9lZZL0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png"><link rel="canonical" href="https://migu316.github.io/2024/01/09/Android/JetPack/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JetPack部分使用心得',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-02 15:34:30'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://lc-zp9lZZL0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/HTML/%E7%85%A7%E7%89%87BootStrap/LinkYou.html"><i class="fa-fw fa fa-globe"></i><span> LinkYou</span></a></div><div class="menus_item"><a class="site-page" href="/HTML/%E7%85%A7%E7%89%87BootStrap/index.html"><i class="fa-fw fa fa-globe"></i><span> 潼南Bootstrap</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Migu'Blog|迷毂"><span class="site-name">Migu'Blog|迷毂</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/HTML/%E7%85%A7%E7%89%87BootStrap/LinkYou.html"><i class="fa-fw fa fa-globe"></i><span> LinkYou</span></a></div><div class="menus_item"><a class="site-page" href="/HTML/%E7%85%A7%E7%89%87BootStrap/index.html"><i class="fa-fw fa fa-globe"></i><span> 潼南Bootstrap</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">JetPack部分使用心得</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-09T07:38:47.892Z" title="发表于 2024-01-09 15:38:47">2024-01-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-02T07:34:30.909Z" title="更新于 2024-04-02 15:34:30">2024-04-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/JetPack/">JetPack</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>96分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="JetPack部分使用心得"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><p>[TOC]</p>
<h1 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a><strong>ViewModel</strong></h1><p>​		ViewModel是在生命周期感知型组件中，ViewModel(<a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=zh_cn">ViewModel 概览  | Android 开发者  | Android Developers</a>) 类是一种<a target="_blank" rel="noopener" href="https://developer.android.com/topic/architecture/ui-layer/stateholders?hl=zh-cn">业务逻辑或屏幕级状态容器</a>。它用于将状态公开给界面，以及封装相关的业务逻辑。 它的主要优点是，它可以缓存状态，并可在配置更改后持久保留相应状态。这意味着在 activity 之间导航时或进行配置更改后（例如旋转屏幕时），界面将无需重新提取数据。</p>
<p>也就是说可以将界面数据交给ViewModel进行管理，那么在view重新创建的部分场景下，处于存活状态的ViewModel的数据就会被Controller中的逻辑代码进行取出，这个过程中对用户来说是无感的。</p>
<p>首先我们需要创建一个管理界面数据的ViewModel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.uibasic.viewmodelpackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.lifecycle.ViewModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewModel</span> <span class="keyword">extends</span> <span class="title class_">ViewModel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在activity中创建这个类的实例，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyViewModel</span> <span class="variable">myViewModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(MyViewModel.class);</span><br></pre></td></tr></table></figure>

<p>因为设备切换横竖屏、修改语言等操作导致的活动重新Create，就不会导致数据丢失，因为数据会保存在ViewModel中，只需要在每次活动创建的时候，获取ViewModel中的数据，将其传递给需要的控件显示即可。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">textView.setText(String.valueOf(myViewModel.number));</span><br></pre></td></tr></table></figure>

<p>当然，在进行数据操作的时候，由于我们将数据和逻辑分离，数据并没有在Activity中。因此，只需要调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myViewModel.number++;</span><br></pre></td></tr></table></figure>

<p>即可完成数据的操作。</p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="/../../images/JetPack/image-20240208203054071.png" alt="image-20240208203054071"></p>
<p> <code>onCleared()</code>函数的调用恰好在ViewModel被销毁之前。这里适合做一些善后清理工作，比如解绑某个数据源。</p>
<p>注意：一个ViewModel绝不能 引用activity或view，否则会引发内存泄漏。</p>
<p>当某个对象强引用另一个要被销毁的对象时，内存泄漏就会发生。这样的强引用会阻止垃圾回收器从内存里清理对象。设备配置改变带来的内存泄漏是常见问题。</p>
<p>设备旋转时，ViewModel实例留在了内存里，而原始activity实例已经被销毁。如果某个ViewModel强引用着原始activity实例，则会带来两个问题：</p>
<ul>
<li>首先，原始activity实例无法从内存里清除，因而它泄漏了；</li>
<li>其次，该ViewModel引用的是一个失效activity。因此，如果 它想更新失效activity的视图，则会抛出 IllegalStateException异常。</li>
</ul>
<h2 id="创建ViewModel的几种方式"><a href="#创建ViewModel的几种方式" class="headerlink" title="创建ViewModel的几种方式"></a>创建ViewModel的几种方式</h2><h3 id="使用ViewModelProvider"><a href="#使用ViewModelProvider" class="headerlink" title="使用ViewModelProvider"></a>使用ViewModelProvider</h3><p>ViewModel拥有独立的生命周期，并且生命周期长于Activity</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ViewModelProvider(&lt;你的Activity或Fragment实例&gt;).<span class="keyword">get</span>(&lt;你的ViewModel&gt;::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>

<p>因此在下面的代码中，我们不能在onCreate中创建ViewModel，而应该创建类属性对象</p>
<p>完整代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ViewModelTestActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> binding:ActivityViewModelTestBinding</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainViewModel: MainViewModel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        binding = ActivityViewModelTestBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(binding.root)</span><br><span class="line"></span><br><span class="line">        mainViewModel = ViewModelProvider(<span class="keyword">this</span>)[MainViewModel::<span class="keyword">class</span>.java]</span><br><span class="line">        Log.i(tag, <span class="string">&quot;onCreate: <span class="variable">$mainViewModel</span>&quot;</span>)</span><br><span class="line">        binding.button7.setOnClickListener &#123;</span><br><span class="line">            mainViewModel.number++</span><br><span class="line">            refreshCounter()</span><br><span class="line">        &#125;</span><br><span class="line">        refreshCounter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">refreshCounter</span><span class="params">()</span></span> &#123;</span><br><span class="line">        binding.textView5.text = mainViewModel.number.toString()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="向ViewModel传递参数-使用ViewModelProvider-Factory"><a href="#向ViewModel传递参数-使用ViewModelProvider-Factory" class="headerlink" title="向ViewModel传递参数-使用ViewModelProvider.Factory()"></a>向ViewModel传递参数-使用ViewModelProvider.Factory()</h3><p>如果需要给ViewModel传递参数，我们还需要实现一个ViewModelProvider.Factory()类，并且重写create方法，在该方法中实现一个MainViewModel实例，将获取到的值通过MainViewModel的构造函数进行传递</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModelFactory</span>(<span class="keyword">private</span> <span class="keyword">val</span> numberReserved:<span class="built_in">Int</span>):ViewModelProvider.Factory &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">		<span class="keyword">return</span> MainViewModel(numberReserved) <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModel</span>(numberReserved: <span class="built_in">Int</span>) : ViewModel() &#123;</span><br><span class="line">    <span class="keyword">var</span> number = numberReserved</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以结合SharedPreferences实现持久化，主要是通过在<code>onCreate</code> <code>onPause</code>两个回调方法中获取和存储需要保存的值</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ViewModelTestActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> binding: ActivityViewModelTestBinding</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainViewModel: MainViewModel</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> sp: SharedPreferences</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        binding = ActivityViewModelTestBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(binding.root)</span><br><span class="line">        sp = getPreferences(MODE_PRIVATE)</span><br><span class="line">        <span class="keyword">val</span> numberReserved = sp.getInt(<span class="string">&quot;number_reserved&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        mainViewModel =</span><br><span class="line">            ViewModelProvider(<span class="keyword">this</span>, MainViewModelFactory(numberReserved))[MainViewModel::<span class="keyword">class</span>.java]</span><br><span class="line"></span><br><span class="line">        binding.button7.setOnClickListener &#123;</span><br><span class="line">            mainViewModel.number++</span><br><span class="line">            refreshCounter()</span><br><span class="line">        &#125;</span><br><span class="line">        binding.button8.setOnClickListener &#123;</span><br><span class="line">            mainViewModel.number = <span class="number">0</span></span><br><span class="line">            refreshCounter()</span><br><span class="line">        &#125;</span><br><span class="line">        refreshCounter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">refreshCounter</span><span class="params">()</span></span> &#123;</span><br><span class="line">        binding.textView5.text = mainViewModel.number.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause()</span><br><span class="line">        sp.edit &#123;</span><br><span class="line">            putInt(<span class="string">&quot;number_reserved&quot;</span>, mainViewModel.number)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上还可以使用<code>SavedStateViewModelFactory</code>进行实现，不需要自己去创建一个Factory类</p>
<h3 id="使用Kotlin扩展插件"><a href="#使用Kotlin扩展插件" class="headerlink" title="使用Kotlin扩展插件"></a>使用Kotlin扩展插件</h3><p>使用下面的这个插件我们可以很方便的实现ViewModel的实例化</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;androidx.activity:activity-ktx:1.7.2&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> mainViewModel <span class="keyword">by</span> viewModels&lt;MainViewModel&gt;()</span><br></pre></td></tr></table></figure>

<h2 id="ViewModel增强-使用ViewModel-SavedStateHandle"><a href="#ViewModel增强-使用ViewModel-SavedStateHandle" class="headerlink" title="ViewModel增强-使用ViewModel SavedStateHandle"></a><strong>ViewModel增强-使用ViewModel SavedStateHandle</strong></h2><p>之所以引入SavedStateHandle，是因为在系统杀死我们的进程后，当用户重新进入的时候，ViewModel是无法恢复数据的，这个时候，使用SavedStateHandle即可解决。并且SavedStateHandle是依靠Activity中的Bundle savedInstanceState参数的。</p>
<p>首先为ViewModel的构造器添加一个SavedStateHandle参数，这个参数会被传递给ViewModel的SavedStateHandle对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ViewModelSavedStateClass</span><span class="params">(SavedStateHandle handle)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.handle = handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个对象中，保存着Controller中由于进程销毁保存的数据。当然Controller中可能会产生很多数据，我们如何进行区分呢？首先，在使用ViewModel后，数据都是存储在ViewModel中的，当ViewModel的数据初始化的时候，需要将其设置给handle，也就是说数据应该是存储在ViewModel中的SavedStateHandle对象（键值对对象）中。由于是键值对类型的对象，因此我们需要先判断handle对象中的这个键是否存在值，如果没有就会初始化这个键。最后返回MutableLiveData<Integer>对象。以及这个常量，最开始是放在Activity中的，但是放在ViewModel中也不会有任何错误，我觉得毕竟数据是在ViewModel中，放在这里面也合情合理~毕竟只是用来存储和识别键值对中的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">MY_KEY</span> <span class="operator">=</span> <span class="string">&quot;my_number&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> MutableLiveData&lt;Integer&gt; <span class="title function_">getNumber</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!handle.contains(MY_KEY)) &#123;</span><br><span class="line">        handle.set(MY_KEY, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> handle.getLiveData(MY_KEY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们就可以在ViewModel的方法中，通过getNumber来使用存储在里面的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">    getNumber().setValue(getNumber().getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于依靠依靠Activity中的Bundle savedInstanceState，也就实现了当活动被系统进程杀死的情况下，通过SavedStateHandle对象将数据进行了保存。因为使用了这个机制，我们需要在创建ViewModel对象的时候，传递一个savedInstanceState对象过去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">viewModelSavedStateClass = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">SavedStateViewModelFactory</span>())</span><br><span class="line">        .get(ViewModelSavedStateClass.class);</span><br></pre></td></tr></table></figure>

<p><strong>完整代码如下</strong>：</p>
<blockquote>
<p>ViewModelSavedStateClass.class</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class ViewModelSavedStateClass extends ViewModel &#123;</span><br><span class="line">    public final static String MY_KEY = &quot;my_number&quot;;</span><br><span class="line">    private SavedStateHandle handle;</span><br><span class="line"></span><br><span class="line">    public ViewModelSavedStateClass(SavedStateHandle handle) &#123;</span><br><span class="line">        this.handle = handle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public MutableLiveData&lt;Integer&gt; getNumber() &#123;</span><br><span class="line">        if (!handle.contains(MY_KEY)) &#123;</span><br><span class="line">            handle.set(MY_KEY, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        return handle.getLiveData(MY_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void add() &#123;</span><br><span class="line">        getNumber().setValue(getNumber().getValue() + 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>activity_main.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;data&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.viewmodelsavedstate.ViewModelSavedStateClass&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/textView&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;String.valueOf(data.number)&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;Button&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;data.add()&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>MainActivity.class</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ActivityMainBinding binding;</span><br><span class="line">    <span class="keyword">public</span> ViewModelSavedStateClass viewModelSavedStateClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        binding = DataBindingUtil.setContentView(<span class="built_in">this</span>, R.layout.activity_main);</span><br><span class="line">        viewModelSavedStateClass = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">SavedStateViewModelFactory</span>())</span><br><span class="line">                .get(ViewModelSavedStateClass.class);</span><br><span class="line">        binding.setLifecycleOwner(<span class="built_in">this</span>);</span><br><span class="line">        binding.setData(viewModelSavedStateClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后一个问题，在布局文件中我们可以看见，依然可以调用data.number，但是我们在ViewModel类中并没有提供这个属性。这是因为getNumber会被底层代码生成一个number属性。但是写法一定要规范，并且遵循驼峰命名。</p>
<h2 id="ViewModel子类-AndroidViewModel"><a href="#ViewModel子类-AndroidViewModel" class="headerlink" title="ViewModel子类-AndroidViewModel"></a><strong>ViewModel子类-AndroidViewModel</strong></h2><p>当我们需要对一些数据进行永久性的保存以及启动时恢复，我们就可以使用SharedPreferences和AndroidViewModel</p>
<p>由于AndroidViewModel是ViewModel的一个子类，因此我们可以直接继承AndroidViewModel，但是需要实现一个有参构造方法</p>
<p>在这个构造方法中，我们添加了一个SavedStateHandle参数，这是为了使得程序在活动重新创建后，可以恢复数据；然后将这个handle传递给MyViewModel类中的handle属性，这可以使得整个类可用。在构造方法被调用的时候，还会判断这个handle中是否存在<code>key</code>这个键，当存在的时候，调用load进行加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MyViewModel</span><span class="params">(<span class="meta">@NonNull</span> Application application, SavedStateHandle handle)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(application);</span><br><span class="line">    <span class="built_in">this</span>.handle = handle;</span><br><span class="line">    <span class="keyword">if</span> (!handle.contains(key)) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用load方法后，因为AndroidViewModel可用调用系统资源，因此可以获取应用程序的名为<code>data</code>的SharedPreferences数据，然后在获取的数据中，通过getInt获取键<code>key</code>的值，如果没有就填写默认值0，然后将handle中的<code>key</code>键的值设置为取出的这个值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载SharedPreferences中的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SharedPreferences</span> <span class="variable">shp</span> <span class="operator">=</span> getApplication().getSharedPreferences(data, Context.MODE_PRIVATE);</span><br><span class="line">    <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> shp.getInt(key, <span class="number">0</span>);</span><br><span class="line">    handle.set(key, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过getNumber获取handle中<code>key</code>键的值，并且返回<code>LiveData&lt;Integer&gt;</code>类型的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LiveData&lt;Integer&gt; <span class="title function_">getNumber</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> handle.getLiveData(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加一个add方法，对handle中<code>key</code>的值进行设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    handle.set(key, getNumber().getValue() == <span class="literal">null</span> ? <span class="number">0</span> : getNumber().getValue() + n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了将值永久保存，编写一个save()方法，将值存储在SharedPreferences中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SharedPreferences</span> <span class="variable">shp</span> <span class="operator">=</span> getApplication().getSharedPreferences(data, Context.MODE_PRIVATE);</span><br><span class="line">    SharedPreferences.<span class="type">Editor</span> <span class="variable">edit</span> <span class="operator">=</span> shp.edit();</span><br><span class="line">    edit.putInt(key, getNumber().getValue() == <span class="literal">null</span> ? <span class="number">0</span> : getNumber().getValue());</span><br><span class="line">    edit.apply();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在activity的生命周期的onPause方法中调用这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onPause();</span><br><span class="line">    viewModel.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>完整代码</strong></p>
<p>MyViewModel.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewModel</span> <span class="keyword">extends</span> <span class="title class_">AndroidViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SavedStateHandle handle;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置SharedPreferences中数据的KEY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getApplication().getString(R.string.my_key);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置SharedPreferences名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> getApplication().getString(R.string.data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LiveData&lt;Integer&gt; <span class="title function_">getNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handle.getLiveData(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyViewModel</span><span class="params">(<span class="meta">@NonNull</span> Application application, SavedStateHandle handle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(application);</span><br><span class="line">        <span class="built_in">this</span>.handle = handle;</span><br><span class="line">        <span class="keyword">if</span> (!handle.contains(key)) &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载SharedPreferences中的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SharedPreferences</span> <span class="variable">shp</span> <span class="operator">=</span> getApplication().getSharedPreferences(data, Context.MODE_PRIVATE);</span><br><span class="line">        <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> shp.getInt(key, <span class="number">0</span>);</span><br><span class="line">        handle.set(key, number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        handle.set(key, getNumber().getValue() == <span class="literal">null</span> ? <span class="number">0</span> : getNumber().getValue() + n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SharedPreferences</span> <span class="variable">shp</span> <span class="operator">=</span> getApplication().getSharedPreferences(data, Context.MODE_PRIVATE);</span><br><span class="line">        SharedPreferences.<span class="type">Editor</span> <span class="variable">edit</span> <span class="operator">=</span> shp.edit();</span><br><span class="line">        edit.putInt(key, getNumber().getValue() == <span class="literal">null</span> ? <span class="number">0</span> : getNumber().getValue());</span><br><span class="line">        edit.apply();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainActivity.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    ActivityMainBinding binding;</span><br><span class="line">    MyViewModel viewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        binding = DataBindingUtil.setContentView(<span class="built_in">this</span>, R.layout.activity_main);</span><br><span class="line">        viewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">SavedStateViewModelFactory</span>())</span><br><span class="line">                .get(MyViewModel.class);</span><br><span class="line">        binding.setData(viewModel);</span><br><span class="line">        binding.setLifecycleOwner(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPause();</span><br><span class="line">        viewModel.save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;data&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.androidviemodeltest.MyViewModel&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">&quot;34sp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;String.valueOf(data.number)&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;+1&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;data.add(1)&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/button2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;-1&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;data.add(-1)&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h1 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a><strong>LiveData</strong></h1><blockquote>
<p>在前面我们使用的修改数据的方式实际上是通过手动点击获取数据并修改。我们如果想实现数据自动修改，可以使用LiveData，注意：不能将Activity传递到ViewModel中进行修改，因为ViewModel的生命周期是长于Activity的，可能会导致Activity无法释放而内存泄漏。</p>
</blockquote>
<p>​		<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/LiveData?hl=zh-cn"><code>LiveData</code></a> 是一种可观察的数据存储器类。与常规的可观察类不同，LiveData 具有生命周期感知能力，意指它遵循其他应用组件（如 activity、fragment 或 service）的生命周期。这种感知能力可确保 LiveData 仅更新处于活跃生命周期状态的应用组件观察者。</p>
<p>​		如果观察者（由 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/Observer?hl=zh-cn"><code>Observer</code></a> 类表示）的生命周期处于 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/Lifecycle.State?hl=zh-cn#STARTED"><code>STARTED</code></a> 或 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/Lifecycle.State?hl=zh-cn#RESUMED"><code>RESUMED</code></a> 状态，则 LiveData 会认为该观察者处于活跃状态。LiveData 只会将更新通知给活跃的观察者。为观察 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/LiveData?hl=zh-cn"><code>LiveData</code></a> 对象而注册的非活跃观察者不会收到更改通知。</p>
<p>您可以注册与实现 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn"><code>LifecycleOwner</code></a> 接口的对象配对的观察者。有了这种关系，当相应的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/Lifecycle?hl=zh-cn"><code>Lifecycle</code></a> 对象的状态变为 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/Lifecycle.State?hl=zh-cn#DESTROYED"><code>DESTROYED</code></a> 时，便可移除此观察者。这对于 activity 和 fragment 特别有用，因为它们可以放心地观察 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/lifecycle/LiveData?hl=zh-cn"><code>LiveData</code></a> 对象，而不必担心泄露（当 activity 和 fragment 的生命周期被销毁时，系统会立即退订它们）。</p>
<blockquote>
<p>比如Activity处于不可见状态（手机息屏、被其他Activity遮挡），此时如果LiveData数据发生了变化，是不会通知给观察者的，只有当重新恢复可见状态的时候，才会进行通知，如果发生了多次更改，也只会通知最新的那份数据<a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/architecture/livedata?hl=zh-cn#the_advantages_of_using_livedata">https://developer.android.google.cn/topic/libraries/architecture/livedata?hl=zh-cn#the_advantages_of_using_livedata</a></p>
</blockquote>
<p>对于LiveData，在这里我们和ViewModel配合使用，在ViewModel中存放的数据，将他的类型包装成MutableLiveData类型，在Controller中我们为数据添加了观察者之后，我们可以通过LiveData实现对UI响应数据的改变，这个过程是在LiveData的底层实现的。这样，我们就可以不使用类似于TextView.setText()这种方法。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p>在ViewModel中创建一个可变的LiveData，类初始化时对属性进行初始化。然后添加两个方法用于增加和清除值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModel</span>(numberReserved: Int) : ViewModel() &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">number</span> <span class="operator">=</span> MutableLiveData&lt;Int&gt;()</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        number.value = numberReserved</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fun <span class="title function_">plusOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">value</span> <span class="operator">=</span> number.value ?: <span class="number">0</span></span><br><span class="line">        number.value = value + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fun <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        number.value = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在处理逻辑的Controller中，获取这个ViewModel的实例，并为需要操作的对象添加一个观察者，该观察者会在数据发生变化的时候，通知UI响应数据的变化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">binding.button7.setOnClickListener &#123;</span><br><span class="line">    mainViewModel.plusOne()</span><br><span class="line">&#125;</span><br><span class="line">binding.button8.setOnClickListener &#123;</span><br><span class="line">    mainViewModel.clear()</span><br><span class="line">&#125;</span><br><span class="line">mainViewModel.number.observe(<span class="built_in">this</span>) &#123;</span><br><span class="line">    binding.textView5.text = it.toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用LiveData对象的<code>observer</code>方法即可设置一个观察者，需要两个参数，参数1：<code>LifeCycleOwner</code>对象 参数2：<code>Observer</code>接口，当数据发生变化时将会回调到这里。</p>
<blockquote>
<p>注意：MutableLiveData主要有3种读写数据的方法</p>
<ul>
<li>**setValue()**：该方法只能在主线程中调用</li>
<li>**getValue()**：获取包含的数据</li>
<li>**postValue()**：该方法用于在非主线程中设置数据</li>
</ul>
</blockquote>
<p><strong>安全性</strong></p>
<p><strong>1</strong>.不推荐暴露一个可变的LiveData给外部，而是提供一个不可被修改的LiveData</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModel</span>(numberReserved: <span class="built_in">Int</span>) : ViewModel() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _number = MutableLiveData&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> number:LiveData&lt;<span class="built_in">Int</span>&gt; <span class="keyword">get</span>() = _number</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        _number.value = numberReserved</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">plusOne</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> value = _number.value ?: <span class="number">0</span></span><br><span class="line">        _number.value = value + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _number.value = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2</strong>.给LiveData观察者函数的第一个参数使用 <strong>生命周期拥有者</strong> ，那么指定的Observer实现的生命周期会和<code>LifecycleOwner</code>所代表的Android组件（比如activity和fragment）的生命周期保持一致</p>
<p>只要Observer实现同步的 生命周期拥有者 （lifecycle owner）处于有效生命周期状态，LiveData对象一有数据更新就会通知它的观察者。<strong>当与Observer实现有着相同生命周期的关联对象不存在了，LiveData对象会自动和Observer实现解除订阅关系</strong>。因为LiveData能响应生命周期变化，所以它还有个名字叫生命周期感知组件 （lifecycle-aware component）</p>
<p><strong>生命周期拥有者</strong>是实现了LifecycleOwner接口并包含Lifecycle对象的一种Android组件。Lifecycle对象用来记录Android生命周期当前状态。（之前说过，activity、fragment、view，甚至是应用进程本身都有它们各自的生命周期。）像已创建和继续运行这样的生命 周期状态可以在Lifecycle.State里枚举。你可以使用<code>Lifecycle.getCurrentState()</code>函数查询Lifecycle的状态，或者用它登记接收生命周期状态变化通知。</p>
<p><strong>fragment</strong>中的<code>viewLifecycleOwner</code>观察到同步的不是fragment自身的生命周期，而是fragment视图的生命周期。虽然是两个不同的生命周期，但fragment视图的生命周期和Fragment实例自身的生命周期是一致的</p>
<h3 id="map和switchMap"><a href="#map和switchMap" class="headerlink" title="map和switchMap"></a>map和switchMap</h3><ul>
<li><p>map函数：将实际包含数据的LiveData和仅用于观察数据的LiveData进行转换</p>
<p>比如下面代码，我们可以将任意一个包含数据的LiveData转换成我们需要对外提供数据的LiveData，包含的数据可以自由的选择提供</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _user = MutableLiveData&lt;User&gt;()</span><br><span class="line"><span class="keyword">val</span> username:LiveData&lt;String&gt; = _user.map &#123; </span><br><span class="line">    <span class="string">&quot;<span class="subst">$&#123;it.firstName&#125;</span> + <span class="subst">$&#123;it.lastName&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>switchMap函数：如果某个LiveData对象是调用另外的方法获取的，那么就可以使用该函数将这个LiveData对象转换出另外一个可观察的LiveData对象</p>
<p>比如我们现在有一个方法获取User信息的LiveData对象，此时我们就不能直接调用该方法获取LiveData对象进行观察，因为每次调用获取到的对象都是不同的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">(userId:<span class="type">String</span>)</span></span>:LiveData&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Repository.getUser(userId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们就可以设置两个LiveData对象，第一个用户监听id的变化，第二个LiveData对象用于获取不同的User的LiveData对象并转换为可被观察的LiveData</p>
<p>在第二个LiveData中，我们使用<code>switchMap&#123;&#125;</code>函数观察<code>userIdLiveData</code>的变化，当该对象的值发生变化的时候，将会自动调用<code>Repository.getUser(userId)</code>方法获取到最新的包含User数据的LiveData对象，并转换为可被观察的对象，对于Activity而言，只需要去观察该LiveData即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听用户id的变化</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> userIdLiveData = MutableLiveData&lt;String&gt;()</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 获取不同id的不同User的LiveData对象</span></span><br><span class="line"><span class="keyword">val</span> user:LiveData&lt;User&gt; = userIdLiveData.switchMap &#123;userId-&gt;</span><br><span class="line">    Repository.getUser(userId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改userId</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">(userId:<span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    userIdLiveData.value = userId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们想要获取数据，但是不提供参数呢？比如说刷新当前UserId的User信息，那么就可以使用如下方法</p>
<p>我们只需要重新将需要刷新的值进行设置，在这里我们直接将原来的值设置给它即可，即可触发一次数据变化</p>
<blockquote>
<p> 对于LiveData，内部不会去检查即将设置的数据和原有的数据是否相同，只要调用了<code>setValue()</code>或者<code>postValue()</code>即可触发数据变化事件</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> refreshLiveData = MutableLiveData&lt;Any?&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> refreshResult = refreshLiveData.switchMap &#123; </span><br><span class="line">    Repository.refresh()    <span class="comment">// 假设该类中存在这个方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">refresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">    refreshLiveData.value = refreshLiveData.value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a><strong>DataBinding</strong></h1><p>​		[<code>数据绑定库</code>](<a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/data-binding?hl=zh-cn">数据绑定库  | Android 开发者  | Android Developers (google.cn)</a>)是一种支持库，借助该库，您可以使用声明性格式（而非程序化地）将布局中的界面组件绑定到应用中的数据源。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342447545">竟然如此简单，DataBinding 和 ViewBinding - 知乎 (zhihu.com)</a></p>
<h3 id="DataBinding-的使用"><a href="#DataBinding-的使用" class="headerlink" title="DataBinding 的使用"></a><strong>DataBinding 的使用</strong></h3><p>因为涉及到的场景比较多，为了减少篇幅，我只列出来核心部分，如果之前从来没有用过，这里只需要知道 DataBinding 的门槛比 Kotlin 合成方法要高即可。</p>
<p><strong>需要给布局文件添加 layout 标签</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    &lt;/LinearLayout</span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>在 Activity 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    <span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line">    binding.lifecycleOwner = <span class="keyword">this</span></span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Fragment 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View &#123;</span><br><span class="line">    <span class="keyword">val</span> binding = FragmentViewBindBinding.inflate(inflater,container,<span class="literal">false</span>)</span><br><span class="line">    binding.lifecycleOwner = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">return</span> binding.root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Adapter 中的使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: RecyclerView.ViewHolder &#123;</span><br><span class="line">    <span class="keyword">val</span> view = LayoutInflater.from(parent.context).inflate(viewType, parent, <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">val</span> bidning:RecycleItemProductBinding =  DataBindingUtil.bind(view) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: SoundHolder &#123;</span><br><span class="line">    <span class="keyword">val</span> binding = DataBindingUtil.inflate&lt;ListItemSoudBinding&gt;(</span><br><span class="line">        LayoutInflater.from(parent.context),</span><br><span class="line">        R.layout.list_item_soud,</span><br><span class="line">        parent,</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> SoundHolder(binding)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Dialog 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    binding = DataBindingUtil.inflate(LayoutInflater.from(context), R.layout.dialog_data_binding, <span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ViewModel和LiveData的代码上面小节一样。我们可以通过使用DataBinding，将Controller对view的引用抽离出来，这样我们就可以在布局文件中处理控件的响应事件，直接是在布局文件中调用需要的方法以及获取需要的数据，进一步的将Controller中的关于界面处理的方法减少了。使用DataBinding，需要在kts文件中进行开启</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">        ...</span><br><span class="line">        dataBinding &#123;</span><br><span class="line">            enable = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>当开启后，布局文件需要进行修改，一般来说布局文件的左边会有一个小灯泡提示如何修改，或者手动添加一个<code>layout</code>根，将布局文件内容包裹起来，并且我们需要添加一个data，这个data可以理解为需要依赖的数据。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;data&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.uibasic.viewmodelpackage.ViewModelAndLiveDataAndDataBinding&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.DataBindingTest&quot;</span>&gt;</span></span><br><span class="line">			...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时，我们就可以在控件中使用这个依赖数据的属性以及方法，使用<code>@&#123;&#125;</code>，在括号中和Java代码一样使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">    android:id=<span class="string">&quot;@+id/data_binding_text_view&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:text=<span class="string">&quot;@&#123;String.valueOf(data.number)&#125;&quot;</span></span><br><span class="line">/&gt;</span><br><span class="line">&lt;ImageButton</span><br><span class="line">    android:id=<span class="string">&quot;@+id/data_binding_imageButton&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:onClick=<span class="string">&quot;@&#123;()-&gt;data.add(1)&#125;&quot;</span></span><br><span class="line">/&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当我们修改完布局文件（可以不先修改控件），就可以在Controller中添加一个类，这个类是自动生成的，由布局文件命名而来，然后在末尾添加了Binding</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActivityDataBindingTestBinding binding;</span><br></pre></td></tr></table></figure>

<p>然后对这个类实例化，使用<code>DataBindingUtil.setContentView</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binding = DataBindingUtil.setContentView(<span class="built_in">this</span>, R.layout.activity_data_binding_test);</span><br></pre></td></tr></table></figure>

<p>此时，当前活动就和这个布局文件绑定了起来，但是我们还需要设置一个<code>data</code>，这个data是我们在布局文件中需要使用的，也就是依赖的数据，这样我们的布局文件才可以使用该实例中的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">viewModelAndLiveDataAndDataBinding = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(ViewModelAndLiveDataAndDataBinding.class);</span><br><span class="line">binding.setData(viewModelAndLiveDataAndDataBinding);</span><br></pre></td></tr></table></figure>

<p>最后需要设置一个LifecycleOwner，也就是一个具有生命周期的活动去管理这个DataBinding对象</p>
<p>关于LifecycleOwner类，文档如下描述</p>
<blockquote>
<p>A class that has an Android lifecycle. These events can be used by custom components to handle lifecycle changes without implementing any code inside the Activity or the Fragment.</p>
<p>一个具有Android生命周期的类。这些事件可以被自定义组件用来处理生命周期的变化，而不需要在Activity或Fragment中实现任何代码。</p>
</blockquote>
<p>使用如下代码进行设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binding.setLifecycleOwner(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>对于setLifecycleOwner方法，文档描述如下：</p>
<blockquote>
<p>Sets the LifecycleOwner that should be used for observing changes of LiveData in this binding. If a LiveData is in one of the binding expressions and no LifecycleOwner is set, the LiveData will not be observed and updates to it will not be propagated to the UI. When using Data Binding with Fragments, make sure to use Fragment.getViewLifecycleOwner(). Using the Fragment as the LifecycleOwner might cause memory leaks since the Fragment’s Lifecycle outlives the view Lifecycle. When using Data Binding with Activities, you can use the Activity as the LifecycleOwner.</p>
<p>设置LifecycleOwner，用于观察绑定中的LiveData的变化。如果LiveData在绑定表达式中，并且没有设置LifecycleOwner，那么LiveData将不会被观察到，对它的更新也不会传播到UI。当使用fragment绑定数据时，请确保使用Fragment.getViewLifecycleOwner()。使用Fragment作为LifecycleOwner可能会导致内存泄漏，因为Fragment的生命周期比view的生命周期长。当使用数据绑定活动时，您可以将活动用作LifecycleOwner。</p>
</blockquote>
<p>注意事项：在使用DataBinding的时候会出现一个编译错误，初步判断是依赖问题，但是不确定如何重现</p>
<p><img src="/../../images/JetPack/error_dataBinding.png" alt="image-20230829173223405"></p>
<blockquote>
<p>解决方法，在kts添加一个依赖：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(platform(<span class="string">&quot;org.jetbrains.kotlin:kotlin-bom:1.8.0&quot;</span>))</span><br></pre></td></tr></table></figure>
</blockquote>
<p>当遇到如下错误的时候：</p>
<p><img src="/../../images/JetPack/error_dataBinding_2.png" alt="error_dataBinding_2"></p>
<p>尝试检查布局文件中对某些数据是否进行了转换，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text=&quot;@&#123;String.valueOf(data.scoreA)&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>当修改了控件的颜色属性后，如果有如下错误：</p>
<p><img src="/../../images/JetPack/error_material_color.png" alt="error_material_color"></p>
<p>这个时候需要注意，某些颜色只能是指定api版本之上的设备才可以使用，比如下面的这种颜色只能在api31及以上的时候才能正常使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:textColor=&quot;@color/material_dynamic_secondary95&quot;</span><br></pre></td></tr></table></figure>

<h1 id="ViewBinding"><a href="#ViewBinding" class="headerlink" title="ViewBinding"></a>ViewBinding</h1><h3 id="ViewBinding-的使用"><a href="#ViewBinding-的使用" class="headerlink" title="ViewBinding 的使用"></a><strong>ViewBinding 的使用</strong></h3><p>因为涉及到的场景比较多，为了减少篇幅，我只列出来核心部分，如果之前从来没有用过，这里只需要知道 ViewBinding 的门槛比 Kotlin 合成方法要高即可。</p>
<p><strong>不想为某个布局生成 binding 类，将下面属性添加到布局文件的根视图中</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">tools:viewBindingIgnore</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>在 Activity 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    <span class="keyword">val</span> binding: ActivityMainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Fragment 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View &#123;</span><br><span class="line">    <span class="keyword">val</span> binding = FragmentViewBindBinding.inflate(inflater,container,<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span> binding.root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Adapter 中的使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: RecyclerView.ViewHolder &#123;</span><br><span class="line">    RecycleItemProductBinding.inflate(LayoutInflater.from(parent.context), parent, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在 Dialog 中使用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    binding = DialogAppBinding.inflate(layoutInflater)</span><br><span class="line">    setContentView(binding.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a><strong>Navigation</strong></h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>在使用navigation的时候，有下面4个需要了解的概念：</p>
<blockquote>
<ol>
<li>**NavHost (导航宿主)**：<ul>
<li>作用：NavHost是一个容器视图，用于托管Fragment的交互式导航。它允许您在同一个Activity中切换和管理不同的Fragment，实现应用程序的导航。</li>
<li>详细作用：NavHost通过加载导航图（NavGraph）中定义的目标Fragment来管理Fragment的交互。每个Activity可以包含一个或多个NavHost，每个NavHost负责一部分导航。</li>
</ul>
</li>
<li>**Fragment (碎片)**：<ul>
<li>作用：Fragment是Android应用程序界面的一部分，代表屏幕上的一块可重用的用户界面。</li>
<li>详细作用：在Navigation中，Fragment用于表示不同的屏幕或导航目标。每个导航目标通常对应一个Fragment，导航组件负责将这些Fragment加载到NavHost中，以实现导航。</li>
</ul>
</li>
<li>**NavController (导航控制器)**：<ul>
<li>作用：NavController是一个控制Fragment导航的对象，它管理着Fragment的切换、返回栈以及导航动作的执行。</li>
<li>详细作用：NavController允许您在Fragment之间进行导航，无需直接管理Fragment事务。您可以使用NavController执行导航操作，例如导航到目标Fragment、返回上一个Fragment等。</li>
</ul>
</li>
<li>**NavGraph (导航图)**：<ul>
<li>作用：NavGraph是一个XML文件，用于定义应用程序的导航结构。它包含了导航目标（例如Fragment）之间的连接以及导航动作。</li>
<li>详细作用：导航图是整个导航组件的核心，它定义了应用程序中不同屏幕之间的关系和导航流程。导航图包含了目标Fragment、导航动作以及这些元素之间的关联。通过导航图，您可以清晰地定义应用程序的导航逻辑。</li>
</ul>
</li>
</ol>
</blockquote>
<h2 id="创建布局"><a href="#创建布局" class="headerlink" title="创建布局"></a>创建布局</h2><p>首先创建了两个碎片布局，如下图所示：</p>
<p><img src="/../../images/JetPack/image-20240109155750582.png" alt="image-20240109155750582"></p>
<p>然后对创建了两个继承自Fragment的类，并重写了OnCreateView方法，在该方法中对碎片视图进行了绑定，然后初始化了需要的控件，然后在onViewCreated方法中，对控件添加监听事件：获取了NavController控制器，然后调用controller的navigate方法，从当前导航图导航到目的地。它既支持通过操作导航，也支持直接导航到目的地。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line">        button.setOnClickListener(view1 -&gt; &#123;</span><br><span class="line">            <span class="type">NavController</span> <span class="variable">controller</span> <span class="operator">=</span> Navigation.findNavController(view1);</span><br><span class="line">            controller.navigate(R.id.action_homeFragment_to_detailFragment);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DetailFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line">  button.setOnClickListener(Navigation.createNavigateOnClickListener(R.id.action_detailFragment_to_homeFragment));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于button的监听事件，两种写法都可以。</p>
<p>完成了碎片的编写后，添加一个NavGraph文件，并且添加导航逻辑</p>
<p><img src="/../../images/JetPack/navigation_navgraph.png" alt="navigation_navgraph"></p>
<p>完成了导航逻辑的添加后，还需要一个NavHost，将这个NavHostFragment添加到activity_main.xml文件中，FragmentContainerView就是添加的NavHostFragment，在文件中，通过app:navGraph指定了上面我们添加的NavGraph资源文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.fragment.app.FragmentContainerView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragmentContainerView3&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;409dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;729dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:defaultNavHost</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/my_nav_graph&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/home_fragment_layout&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<p>如果将组件拖动到组件树栏中，是不会生成部分属性的，比如</p>
<p>app:navGraph指定导航视图，即建好的nav_graph.xml</p>
<p>app:defaultNavHost&#x3D;true 意思是可以拦截系统的返回键，可以理解为默认给fragment实现了返回键的功能，这样在fragment的跳转过程中，当我们按返回键时，就可以使得fragment跟activity一样可以回到上一个页面了</p>
<p>如果忘记会导致我们在其他视图中点击返回键时，出现直接返回到桌面的问题</p>
<p>参见<a target="_blank" rel="noopener" href="https://juejin.cn/post/6898234461361307655/#heading-18">安卓navigation系列——入门篇 - 掘金 (juejin.cn)</a></p>
</blockquote>
<p>这样，我们就编写好了navigation，并且可以在碎片之间进行跳转。</p>
<h2 id="实现bar栏点击图标返回"><a href="#实现bar栏点击图标返回" class="headerlink" title="实现bar栏点击图标返回"></a>实现bar栏点击图标返回</h2><p>如果需要在bar栏有一个返回按钮，那么在MainActivity类中进行修改：首先获取了Controller，然后将这个Controller通过NavigationUI.setupActionBarWithNavController添加进去，再重写一个回调方法，实现应用程序中的向上导航的操作。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/navigation/navigation-ui?hl=zh_cn">使用 NavigationUI 更新界面组件  | Android 开发者  | Android Developers (google.cn)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        </span><br><span class="line">        <span class="type">NavHostFragment</span> <span class="variable">navHostFragment</span> <span class="operator">=</span> (NavHostFragment)getSupportFragmentManager().findFragmentById(R.id.fragmentContainerView3);</span><br><span class="line">        <span class="type">NavController</span> <span class="variable">navController</span> <span class="operator">=</span> navHostFragment.getNavController();</span><br><span class="line">        NavigationUI.setupActionBarWithNavController(<span class="built_in">this</span>, navController);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onSupportNavigateUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NavController</span> <span class="variable">controller</span> <span class="operator">=</span> Navigation.findNavController(<span class="built_in">this</span>, R.id.fragmentContainerView3);</span><br><span class="line">        <span class="keyword">return</span> controller.navigateUp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Navigation-传递数据"><a href="#Navigation-传递数据" class="headerlink" title="Navigation-传递数据"></a>Navigation-传递数据</h2><h3 id="使用Safe-Args传递类型安全的数据"><a href="#使用Safe-Args传递类型安全的数据" class="headerlink" title="使用Safe Args传递类型安全的数据"></a>使用Safe Args传递类型安全的数据</h3><p>对于这种方法是需要开启一个插件的，参见<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/navigation/use-graph/pass-data?hl=zh-cn">在目的地之间传递数据  | Android 开发者  | Android Developers (google.cn)</a></p>
<p>在NavGraph的xml文件中为action设置默认值，使用argument参数进行设置，采用键值对的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">    android:id=<span class="string">&quot;@+id/homeFragment&quot;</span></span><br><span class="line">    android:name=<span class="string">&quot;com.example.navigationdemo2.HomeFragment&quot;</span></span><br><span class="line">    android:label=<span class="string">&quot;HomeFragment&quot;</span> &gt;</span><br><span class="line">    &lt;action</span><br><span class="line">        android:id=<span class="string">&quot;@+id/action_homeFragment_to_detailFragment&quot;</span></span><br><span class="line">        app:destination=<span class="string">&quot;@id/detailFragment&quot;</span></span><br><span class="line">        app:enterAnim=<span class="string">&quot;@anim/scale&quot;</span></span><br><span class="line">        app:exitAnim=<span class="string">&quot;@anim/exit_right_to_left&quot;</span>&gt;</span><br><span class="line">        &lt;argument</span><br><span class="line">            android:name=<span class="string">&quot;name&quot;</span></span><br><span class="line">            android:defaultValue=<span class="string">&quot;Rose&quot;</span> /&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">&lt;/fragment&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/JetPack/image-20240225154618462.png" alt="image-20240225154618462"></p>
<p>当然，我们也可以在导航的目的地设置数据的默认值，当没有没有传递任何数据过来的时候，就会显示设置的默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;fragment</span><br><span class="line">    android:id=<span class="string">&quot;@+id/detailFragment&quot;</span></span><br><span class="line">    android:name=<span class="string">&quot;com.example.navigationdemo2.DetailFragment&quot;</span></span><br><span class="line">    android:label=<span class="string">&quot;DetailFragment&quot;</span> &gt;</span><br><span class="line">    &lt;argument</span><br><span class="line">        android:name=<span class="string">&quot;name&quot;</span></span><br><span class="line">        app:argType=<span class="string">&quot;string&quot;</span></span><br><span class="line">        android:defaultValue=<span class="string">&quot;Jack&quot;</span> /&gt;</span><br><span class="line">&lt;/fragment&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用bundle传递数据"><a href="#使用bundle传递数据" class="headerlink" title="使用bundle传递数据"></a><strong>使用bundle传递数据</strong></h3><p>创建一个Bundle对象，将值进行填充后，通过controller.navigation方法，以参数的形式进行传递。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> bundle = Bundle().apply &#123;</span><br><span class="line">    putSerializable(<span class="string">&quot;crime_id&quot;</span>, crime.id)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">val</span> controller = Navigation.findNavController(binding.view)</span><br><span class="line">controller.navigate(R.id.action_crimeListFragment_to_crimeFragment, bundle)</span><br></pre></td></tr></table></figure>

<p>然后我们可以在导航的目的地中，将传递过来的bundle对象取出我们需要的数据，同样是使用键值对，将数据通过<code>argument</code>函数进行取出。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> ARG_CRIME_ID = <span class="string">&quot;crime_id&quot;</span>   </span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">       crime = Crime()</span><br><span class="line">       <span class="keyword">val</span> crimeId = arguments?.getSerializable(ARG_CRIME_ID) <span class="keyword">as</span> UUID</span><br><span class="line">       crimeDetailViewModel.loadCrime(crimeId)</span><br><span class="line">       Log.d(TAG, <span class="string">&quot;UUID is <span class="variable">$crimeId</span>&quot;</span>)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Navigation-共享数据"><a href="#Navigation-共享数据" class="headerlink" title="Navigation-共享数据"></a><strong>Navigation-共享数据</strong></h2><p>通过使用Navigation，我们可以实现碎片之间的跳转。如果要实现数据共享，那么就需要使用到ViewModel、LiveData、DataBinding，因此我们需要创建一个ViewModel，在ViewModel中创建一个LiveData<T>类型的number，然后使用DataBinding将这个number和碎片的视图进行绑定，即可实现数据共享。但是需要注意的是，这个number必须是一个单例，因为在每个碎片创建的时候都会回调，而number的初始化是在回调方法onCreateView中实现的。</p>
<p>在两个碎片中，第一个视图调用了seekbar改变了number的数值后，通过navigation导航到第二个视图，共享的数据将会被显示到第二个视图上，然后在第二个视图上进行数据操作后，进行返回，可以发现修改后的数据被正确的显示出来，并且同时反映到了seekbar上。</p>
<blockquote>
<p>注意事项：</p>
<p>1.需要注意的是，seekbar会被默认开启android:saveEnabled&#x3D;”true”，开启这个选项后，当修改了数据后，通过back键按下，然后第一个碎片进入栈顶，会导致重新创建一个Fragment，并且将之前保存的数据恢复，导致了back键被按下后，数据被恢复到了之前的状态。因此需要将这个属性修改为false。</p>
<p>2.当我们进入一个碎片的时候，会导致碎片被重复创建以及压入栈中，当我们尝试返回的时候，会导致点击很多次back后，才可以退出程序，这是由于栈中存在重复的碎片导致的。需要为navgraph的action设置下列的属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app:popUpTo=&quot;@id/homeFragment&quot;</span><br><span class="line">app:popUpToInclusive=&quot;true&quot; </span><br></pre></td></tr></table></figure>

<p>这会使得当这个action被调用后，弹出栈中的全部碎片，然后将homeFragment压入栈中，此时栈中只有这个碎片并且是栈顶，再次按下back键的时候就会退出应用程序。</p>
</blockquote>
<p><strong>完整代码</strong></p>
<blockquote>
<p>布局</p>
</blockquote>
<p>activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.fragment.app.FragmentContainerView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragmentContainerView&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;409dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;729dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:defaultNavHost</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/my_nav&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>fragment_home.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;data&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.navigationdemo3.MyViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.HomeFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/textView&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;@&#123;String.valueOf(data.number)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">&quot;34sp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">SeekBar</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/seekBar&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginStart</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline2&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;@+id/guideline&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:saveEnabled</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:max</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginStart</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;Button&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline3&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;@+id/guideline2&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.3&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline2&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.45&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline3&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.65&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>fragment_detail.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;data&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.example.navigationdemo3.MyViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.DetailFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/textView2&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;@&#123;String.valueOf(data.number)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">&quot;34sp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline4&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline4&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.3&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/button2&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;+1&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;data.add(1)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline6&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toStartOf</span>=<span class="string">&quot;@+id/guideline5&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;@+id/guideline4&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/button3&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;-1&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:onClick</span>=<span class="string">&quot;@&#123;()-&gt;data.add(-1)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline6&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;@+id/guideline5&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;@+id/guideline4&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline5&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.50121653&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline6&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.500684&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/button4&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginStart</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">&quot;返回Home&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/guideline7&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;@+id/guideline6&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.Guideline</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/guideline7&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:layout_constraintGuide_percent</span>=<span class="string">&quot;0.65&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>my_nav.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/my_nav&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:startDestination</span>=<span class="string">&quot;@id/homeFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/homeFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.navigationdemo3.HomeFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;fragment_home&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_home&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_homeFragment_to_detailFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:destination</span>=<span class="string">&quot;@id/detailFragment&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/detailFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.navigationdemo3.DetailFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;fragment_detail&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_detail&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_detailFragment_to_homeFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:destination</span>=<span class="string">&quot;@id/homeFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:popUpTo</span>=<span class="string">&quot;@id/homeFragment&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:popUpToInclusive</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>逻辑代码</p>
</blockquote>
<p>MyViewModel.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyViewModel</span> <span class="keyword">extends</span> <span class="title class_">ViewModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MutableLiveData&lt;Integer&gt; number;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MutableLiveData&lt;Integer&gt; <span class="title function_">getNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (number == <span class="literal">null</span>) &#123;</span><br><span class="line">            number = <span class="keyword">new</span> <span class="title class_">MutableLiveData</span>&lt;&gt;();</span><br><span class="line">            number.setValue(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        number.setValue(number.getValue() + n);</span><br><span class="line">        <span class="keyword">if</span> (number.getValue() &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            number.setValue(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (number.getValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            number.setValue(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HomeFragment.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    FragmentHomeBinding binding;</span><br><span class="line">    MyViewModel myViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        myViewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(getActivity()).get(MyViewModel.class);</span><br><span class="line">        binding = DataBindingUtil.inflate(inflater, R.layout.fragment_home, container, <span class="literal">false</span>);</span><br><span class="line">        binding.setData(myViewModel);</span><br><span class="line">        binding.setLifecycleOwner(getActivity());</span><br><span class="line">        <span class="keyword">return</span> binding.getRoot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line"></span><br><span class="line">        binding.seekBar.setProgress(myViewModel.getNumber().getValue());</span><br><span class="line">        binding.seekBar.setOnSeekBarChangeListener(<span class="keyword">new</span> <span class="title class_">SeekBar</span>.OnSeekBarChangeListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChanged</span><span class="params">(SeekBar seekBar, <span class="type">int</span> i, <span class="type">boolean</span> b)</span> &#123;</span><br><span class="line">                myViewModel.getNumber().setValue(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartTrackingTouch</span><span class="params">(SeekBar seekBar)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStopTrackingTouch</span><span class="params">(SeekBar seekBar)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        binding.button.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            <span class="type">NavController</span> <span class="variable">controller</span> <span class="operator">=</span> Navigation.findNavController(v);</span><br><span class="line">            controller.navigate(R.id.action_homeFragment_to_detailFragment);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DetailFragment.java</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class DetailFragment extends Fragment &#123;</span><br><span class="line">    FragmentDetailBinding binding;</span><br><span class="line">    MyViewModel myViewModel;</span><br><span class="line"></span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        myViewModel = new ViewModelProvider(getActivity()).get(MyViewModel.class);</span><br><span class="line">        binding = DataBindingUtil.inflate(inflater, R.layout.fragment_detail, container, false);</span><br><span class="line">        binding.setData(myViewModel);</span><br><span class="line">        binding.setLifecycleOwner(getActivity());</span><br><span class="line">        return binding.getRoot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">        binding.button4.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            NavController controller = Navigation.findNavController(v);</span><br><span class="line">            controller.navigate(R.id.action_detailFragment_to_homeFragment);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Navigation-开启actionBar"><a href="#Navigation-开启actionBar" class="headerlink" title="Navigation-开启actionBar"></a><strong>Navigation-开启actionBar</strong></h2><p>开启actionBar后，会当碎片的左上角提供一个用于返回的按钮</p>
<blockquote>
<p>注意：需要使用带有actionBar的主题或者使用ToolBar</p>
</blockquote>
<p>在activity中获取Navigation的Controller的时候，需要使用如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NavHostFragment</span> <span class="variable">navHostFragment</span> <span class="operator">=</span> (NavHostFragment)getSupportFragmentManager().findFragmentById(R.id.fragmentContainerView3);</span><br><span class="line"><span class="type">NavController</span> <span class="variable">navController</span> <span class="operator">=</span> navHostFragment.getNavController();</span><br><span class="line">NavigationUI.setupActionBarWithNavController(<span class="built_in">this</span>, navController);</span><br></pre></td></tr></table></figure>

<p>然后重写onSupportNavigateUp方法，在该方法中调用controller的navigateUp回退到碎片栈中的上一个碎片，也就是说上一级，或者使用导航，跳转到对应的页面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        NavHostFragment navHostFragment = (NavHostFragment)getSupportFragmentManager().findFragmentById(R.id.fragmentContainerView3);</span><br><span class="line">        NavController navController = navHostFragment.getNavController();</span><br><span class="line">        NavigationUI.setupActionBarWithNavController(this, navController);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean onSupportNavigateUp() &#123;</span><br><span class="line">        NavController controller = Navigation.findNavController(this, R.id.fragmentContainerView3);</span><br><span class="line">        return controller.navigateUp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="感知生命周期LifeCycles"><a href="#感知生命周期LifeCycles" class="headerlink" title="感知生命周期LifeCycles"></a><strong>感知生命周期LifeCycles</strong></h1><p>我们经常会遇到需要感知生命周期的情况，比如发起网络请求，如果activity已经被关闭，那么网络请求不应该继续处理。</p>
<p>当我们需要一个计时器的时候，可以自定义一个Chronometer，这个自定义类需要继承自Chronometer，如果需要让它感知生命周期，那么就需要实现LifecycleEventObserver接口，这个接口可以观察activity的生命周期，实现不同阶段做不同的事情。（由于LifecycleObserver已经被弃用，因此使用LifecycleEventObserver）</p>
<p>生命周期事件的类型一共有7种</p>
<p><code>ON_CREATE</code></p>
<p><code>ON_START</code></p>
<p><code>ON_RESUME</code></p>
<p><code>ON_PAUSE</code></p>
<p><code>ON_STOP</code></p>
<p><code>ON_DESTROY</code></p>
<p><code>ON_ANY</code></p>
<p>使用LifecycleEventObserver需要实现一个接口方法，该方法会在生命周期状态发生改变的时候调用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLifecycleObserver</span> : <span class="type">LifecycleEventObserver</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口方法有两个参数</p>
<blockquote>
<p>source是一个具有生命周期的类，如activity</p>
<p>event是一个枚举类，其中枚举了activity的生命周期</p>
</blockquote>
<p>通过判断event就可以判断出生命周期的阶段</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLifecycleObserver</span> : <span class="type">LifecycleEventObserver</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (event) &#123;</span><br><span class="line">            Lifecycle.Event.ON_START -&gt; &#123;</span><br><span class="line">                Log.i(tag, <span class="string">&quot;onStateChanged: 启动&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            Lifecycle.Event.ON_STOP -&gt; &#123;</span><br><span class="line">                Log.i(tag, <span class="string">&quot;onStateChanged: 关闭&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Java实现：主要是Longway777视频中的定时器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Lifecycle.Event event) &#123;</span><br><span class="line">    Log.d(&quot;tag&quot;, &quot;onStateChanged: &quot; + source);</span><br><span class="line">    switch (event) &#123;</span><br><span class="line">        case ON_PAUSE: &#123;</span><br><span class="line">            elapsedTime = SystemClock.elapsedRealtime() - getBase();</span><br><span class="line">            stop();</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">        case ON_RESUME: &#123;</span><br><span class="line">            setBase(SystemClock.elapsedRealtime() - elapsedTime);</span><br><span class="line">            start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于实现resume阶段，计时器重新计时，可以使用下面的方法</p>
<blockquote>
<p>elapsedTime为获取的计时器控件已经运行了多少时间，如果是5秒，那么当resume后，获取到系统当前时间，然后减去5秒，将这个时间设置为计时器的基准；这样对于计时器来说，从基准时间到resume的时间正好是5秒，那么计时器显示的也就是5秒，然后就会重新开始计时。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setBase(SystemClock.elapsedRealtime() - elapsedTime);</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>弃用</p>
<p>在使用<code>LifecycleObserver</code>的时候，需要使用注解去实现生命周期不同阶段的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resumeMeter</span><span class="params">()</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</blockquote>
<p><strong>添加生命周期观察</strong></p>
<p>一般我们是通过如下代码添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lifecycleOwner.lifecycle.addObserver(MyObserver())</span><br></pre></td></tr></table></figure>

<p>但是如果<code>Activity</code>是继承自<code>AppCompatActivity</code>、<code>Fragment</code>是继承自<code>androidx.fragment.app.Fragment</code>，那么他们本身就是一个LifecycleOwner实例，那么我们就可以在Activity中这样写</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册生命周期观察者</span></span><br><span class="line">lifecycle.addObserver(MyLifecycleObserver())</span><br></pre></td></tr></table></figure>

<p><strong>主动获取当前生命周期状态</strong></p>
<p>在上面的示例中，我们一直都是被动的获取生命周期的状态，却不能主动获取，因此我们可以添加一个<code>Lifecycle</code>参数主动获取状态</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLifecycleObserver</span>(<span class="keyword">val</span> lifecycle: Lifecycle) :LifecycleEventObserver</span><br></pre></td></tr></table></figure>

<h3 id="Activity生命周期状态与事件的对应关系"><a href="#Activity生命周期状态与事件的对应关系" class="headerlink" title="Activity生命周期状态与事件的对应关系"></a>Activity生命周期状态与事件的对应关系</h3><p><img src="/../../images/JetPack/image-20240210202851413.png" alt="image-20240210202851413"></p>
<h1 id="Room"><a href="#Room" class="headerlink" title="Room"></a><strong>Room</strong></h1><p><img src="/../../images/JetPack/Room.png" alt="Room"></p>
<p>处理大量结构化数据的应用可极大地受益于在本地保留这些数据。最常见的使用场景是缓存相关的数据，这样一来，当设备无法访问网络时，用户仍然可以在离线状态下浏览该内容。</p>
<p>Room 持久性库在 SQLite 上提供了一个抽象层，以便在充分利用 SQLite 的强大功能的同时，能够流畅地访问数据库。具体来说，Room 具有以下优势：</p>
<ul>
<li>针对 SQL 查询的编译时验证。</li>
<li>可最大限度减少重复和容易出错的样板代码的方便注解。</li>
<li>简化了数据库迁移路径。</li>
</ul>
<p>出于这些方面的考虑，我们强烈建议您使用 Room，而不是<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/data-storage/sqlite?hl=zh-cn">直接使用 SQLite API</a>。</p>
<h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>对于Kotlin项目，我们需要使用kapt或者ksp插件进行引入Room的编译时注解库</p>
<ol>
<li><p>在顶层build.gradle文件中声明插件</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id(<span class="string">&quot;com.google.devtools.ksp&quot;</span>) version <span class="string">&quot;1.9.22-1.0.17&quot;</span> apply <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在模块级别的build.gradle文件中启用Ksp或者Kapt(该插件忽略第一步)</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id(<span class="string">&quot;kotlin-kapt&quot;</span>)</span><br><span class="line">    id(<span class="string">&quot;com.google.devtools.ksp&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加依赖</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">val</span> room_version = <span class="string">&quot;2.6.1&quot;</span></span><br><span class="line">    implementation(<span class="string">&quot;androidx.room:room-runtime:<span class="variable">$room_version</span>&quot;</span>)</span><br><span class="line"><span class="comment">//    kapt(&quot;androidx.room:room-compiler:$room_version&quot;)</span></span><br><span class="line">    ksp(<span class="string">&quot;androidx.room:room-compiler:<span class="variable">$room_version</span>&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>对于Java项目只需要使用<code>annotationProcessor</code>即可</p>
<p>注意，使用ksp插件需要kotlin版本号与ksp前缀的版本号一致，如：均使用1.9.22</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id(<span class="string">&quot;com.android.application&quot;</span>) version <span class="string">&quot;8.2.2&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">&quot;org.jetbrains.kotlin.android&quot;</span>) version <span class="string">&quot;1.9.22&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">&quot;com.google.devtools.ksp&quot;</span>) version <span class="string">&quot;1.9.22-1.0.17&quot;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><ol>
<li><p><strong>定义Entity</strong></p>
<p><code>@Entity</code>注解声明为一个实体</p>
<p><code>@PrimaryKey</code>注解声明为主键 <code>autoGenerate</code>设置为自动生成主键</p>
<p><code>@ColumnInfo(name = &quot;firstName&quot;)</code>注解声明字段的名称</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">UserEntity</span>(<span class="keyword">var</span> firstName:String, <span class="keyword">var</span> lastName:String, <span class="keyword">var</span> age:<span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="keyword">var</span> id:<span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义Dao层接口，访问数据库的操作在这里封装</p>
<p><code>Dao</code>注解声明该接口为Dao封装的接口</p>
<p>对于数据库中的增删改查，提供了四个注解<code>Insert</code> <code>Update</code> <code>Query</code> <code>Delete</code>使用，对于需要实现多样化的逻辑，那么只能使用<code>Query</code>注解和自定义SQL实现</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insertUser</span><span class="params">(user: <span class="type">UserEntity</span>)</span></span>:<span class="built_in">Long</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateUser</span><span class="params">(newUser: <span class="type">UserEntity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;select * from UserEntity&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">loadAllUsers</span><span class="params">()</span></span>:List&lt;UserEntity&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;select * from UserEntity where age &gt; :age&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">loadUsersOlderThan</span><span class="params">(age:<span class="type">Int</span>)</span></span>: List&lt;UserEntity&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteUser</span><span class="params">(user: <span class="type">UserEntity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;delete from UserEntity where lastName = :lastName&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteUserByLastName</span><span class="params">(lastName:<span class="type">String</span>)</span></span>:<span class="built_in">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义Database</p>
<p>这个部分需要定义数据库的版本号、包含哪些实体类、Dao层访问实例</p>
<p><code>@Database</code>注解用于声明当前类为Database类，并提供版本号、包含哪些实体类</p>
<p>该抽象类需要继承自<code>RoomDatabase</code>类，并且提供一个用于获取Dao实例的抽象方法，无需实现，将会由Room底层去实现</p>
<p>使用单例模式提供一个获取Database的方法。这里使用了instance变量来缓存AppDatabase的实例，然后 在getDatabase()方法中判断：如果instance变量不为空就直接返回，否则就调用 Room.databaseBuilder()方法来构建一个AppDatabase的实例。</p>
<p>databaseBuilder() 方法接收3个参数</p>
<ul>
<li><p>第一个参数一定要使用applicationContext，而不能使用普通的 context，否则容易出现内存泄漏的情况。</p>
</li>
<li><p>第二个参数是AppDatabase的Class类型</p>
</li>
<li><p>第三个参数是数据库名</p>
</li>
</ul>
<p>最后调用build()方法完成构建，并将创建出来的实例赋值给instance变量，然 后返回当前实例即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(version = 1, entities = [UserEntity::class])</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AppDatabase</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">userDao</span><span class="params">()</span></span>: UserDao</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> instance: AppDatabase? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Synchronized</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getDatabase</span><span class="params">(context: <span class="type">Context</span>)</span></span>: AppDatabase &#123;</span><br><span class="line">            instance?.let &#123;</span><br><span class="line">                <span class="keyword">return</span> it</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Room.databaseBuilder(</span><br><span class="line">                context.applicationContext,</span><br><span class="line">                AppDatabase::<span class="keyword">class</span>.java,</span><br><span class="line">                <span class="string">&quot;app_database&quot;</span></span><br><span class="line">            ).build().apply &#123;</span><br><span class="line">                instance = <span class="keyword">this</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="处理其他对象类型"><a href="#处理其他对象类型" class="headerlink" title="处理其他对象类型"></a>处理其他对象类型</h3><p>Room能直接在后台SQLite数据库表里存储基本类型数据，但遇到其他数据类型就会有问题。Crime类要靠Date和UUID对象支持。但Room默认不知道该如何存储这些数据类型。</p>
<p>为了让Room知道该如何做数据类型转换，你需要指定一个 类型转换器（type converter）。类型转换器会告诉Room如何转换要保存的特定类型的数据。要完成Date和UUID的数据类型转换，需要四个分别用<code>@TypeConverter</code>注解的函数——每种数据类型两个，一个用来告诉Room如何转换成可保存的数据类型，另一个用来告诉Room如何再恢复成原来的数据类型。</p>
<p><strong>创建类型转换器</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CrimeTypeConverters</span> &#123;</span><br><span class="line">    <span class="meta">@TypeConverter</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fromDate</span><span class="params">(date: <span class="type">Date</span>?)</span></span>: <span class="built_in">Long</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> date?.time</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TypeConverter</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">toDate</span><span class="params">(millisSinceEpoh: <span class="type">Long</span>?)</span></span>: Date? &#123;</span><br><span class="line">        <span class="keyword">return</span> millisSinceEpoh?.let &#123;</span><br><span class="line">            Date(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TypeConverter</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fromUUID</span><span class="params">(uuid: <span class="type">UUID</span>?)</span></span>: String? &#123;</span><br><span class="line">        <span class="keyword">return</span> uuid?.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TypeConverter</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">toUUID</span><span class="params">(uuid: <span class="type">String</span>?)</span></span>: UUID? &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.fromString(uuid)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用类型转换器</strong></p>
<p>在Database类上使用<code>@TypeConverters</code>注解声明转换器即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [Crime::class], version = 1)</span></span><br><span class="line"><span class="meta">@TypeConverters(CrimeTypeConverters::class)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CrimeDatabase</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">crimeDao</span><span class="params">()</span></span>: CrimeDao</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用</strong></p>
<p>我们需要获取Dao实例，以便调用其中的方法</p>
<p>需要注意，由于数据库操作是耗时操作，Room默认不允许在UI线程中执行，因此需要将代码放在子线程中。为了方便测试，可以在构建Database的时候使用<code>allowMainThreadQueries()</code>函数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Room.databaseBuilder(context.applicationContext,AppDatabase::<span class="keyword">class</span>.java,<span class="string">&quot;app_database&quot;</span>)</span><br><span class="line">                .allowMainThreadQueries()</span><br><span class="line">                .build()</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> userDao = AppDatabase.getDatabase(<span class="keyword">this</span>).userDao()</span><br><span class="line"><span class="keyword">val</span> user1 = UserEntity(<span class="string">&quot;罗&quot;</span>, <span class="string">&quot;林&quot;</span>, <span class="number">22</span>)</span><br><span class="line"><span class="keyword">val</span> user2 = UserEntity(<span class="string">&quot;林&quot;</span>, <span class="string">&quot;冲&quot;</span>, <span class="number">220</span>)</span><br><span class="line"></span><br><span class="line">binding.apply &#123;</span><br><span class="line">    addButton.setOnClickListener &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            user1.id = userDao.insertUser(user1)</span><br><span class="line">            user2.id = userDao.insertUser(user2)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateButton.setOnClickListener &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            user1.age = <span class="number">42</span></span><br><span class="line">            userDao.updateUser(user1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deleteButton.setOnClickListener &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            userDao.deleteUserByLastName(<span class="string">&quot;冲&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    queryButton.setOnClickListener &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">val</span> builder = StringBuilder()</span><br><span class="line">            <span class="keyword">for</span>(user <span class="keyword">in</span> userDao.loadAllUsers()) &#123;</span><br><span class="line">                builder.append(user)</span><br><span class="line">                builder.append(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            runOnUiThread &#123;</span><br><span class="line">                dataTextView.text = builder.toString()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Room数据库升级"><a href="#Room数据库升级" class="headerlink" title="Room数据库升级"></a>Room数据库升级</h2><p>暴力升级方法<code>fallbackToDestructiveMigration()</code>，将会导致数据库数据丢失</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Room.databaseBuilder(context.applicationContext,AppDatabase::<span class="keyword">class</span>.java,<span class="string">&quot;app_database&quot;</span>)</span><br><span class="line">                .fallbackToDestructiveMigration()</span><br><span class="line">                .build()</span><br></pre></td></tr></table></figure>

<h3 id="增加表"><a href="#增加表" class="headerlink" title="增加表"></a>增加表</h3><p>比如我们现在增加了一个实体类和一个Dao层封装</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Book</span>(<span class="keyword">var</span> name: String, <span class="keyword">var</span> pages: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insertBook</span><span class="params">(book: <span class="type">Book</span>)</span></span>: <span class="built_in">Long</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;select * from Book&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">loadAllBooks</span><span class="params">()</span></span>: List&lt;Book&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于升级数据库</p>
<ol>
<li>我们首先需要修改版本号，然后在实体列表中添加刚刚新增的类</li>
<li>添加抽象方法用于获取实例</li>
<li>在伴生对象中实现一个匿名内部类<code>Migration</code>并传递升级前和升级后的版本号，并实现migrate方法，在该方法中我们需要执行新增表的SQL语句，需要和实体类中的字段一致</li>
<li>在构建Database时，将该Migration对象使用<code>addMigrations()</code>进行传递</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(version = 2, entities = [UserEntity::class, Book::class])</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AppDatabase</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">userDao</span><span class="params">()</span></span>: UserDao</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">bookDao</span><span class="params">()</span></span>: BookDao</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> MIGRATION_1_2 = <span class="keyword">object</span> :Migration(<span class="number">1</span>,<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">migrate</span><span class="params">(db: <span class="type">SupportSQLiteDatabase</span>)</span></span> &#123;</span><br><span class="line">                db.execSQL(<span class="string">&quot;create table Book (&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;id integer primary key autoincrement not null,&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;name text not null,&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;pages integer not null&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;)&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> instance: AppDatabase? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Synchronized</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getDatabase</span><span class="params">(context: <span class="type">Context</span>)</span></span>: AppDatabase &#123;</span><br><span class="line">            instance?.let &#123;</span><br><span class="line">                <span class="keyword">return</span> it</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Room.databaseBuilder(</span><br><span class="line">                context.applicationContext,</span><br><span class="line">                AppDatabase::<span class="keyword">class</span>.java,</span><br><span class="line">                <span class="string">&quot;app_database&quot;</span></span><br><span class="line">            )</span><br><span class="line">                .addMigrations(MIGRATION_1_2)</span><br><span class="line">                .build().apply &#123;</span><br><span class="line">                instance = <span class="keyword">this</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><p>比如现在给Book实体添加了一个作者字段</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Book</span>(<span class="keyword">var</span> name: String, <span class="keyword">var</span> pages: <span class="built_in">Int</span>, <span class="keyword">var</span> author: String) &#123;</span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们需要升级数据库，同样先修改版本号，然后创建Migration对象，最后通过<code>addMigrations()</code>方法进行传递</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(version = 3, entities = [UserEntity::class, Book::class])</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AppDatabase</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">		...</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> MIGRATION_2_3 = <span class="keyword">object</span> :Migration(<span class="number">2</span>,<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">migrate</span><span class="params">(db: <span class="type">SupportSQLiteDatabase</span>)</span></span> &#123;</span><br><span class="line">                db.execSQL(<span class="string">&quot;alter table Book add column author text not null default &#x27;unknown&#x27;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Synchronized</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getDatabase</span><span class="params">(context: <span class="type">Context</span>)</span></span>: AppDatabase &#123;</span><br><span class="line">            instance?.let &#123;</span><br><span class="line">                <span class="keyword">return</span> it</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Room.databaseBuilder(</span><br><span class="line">                context.applicationContext,</span><br><span class="line">                AppDatabase::<span class="keyword">class</span>.java,</span><br><span class="line">                <span class="string">&quot;app_database&quot;</span></span><br><span class="line">            )</span><br><span class="line">                .addMigrations(MIGRATION_1_2, MIGRATION_2_3)</span><br><span class="line">                .build().apply &#123;</span><br><span class="line">                instance = <span class="keyword">this</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="对Room的优化-使用ViewModel架构"><a href="#对Room的优化-使用ViewModel架构" class="headerlink" title="对Room的优化-使用ViewModel架构"></a><strong>对Room的优化-使用ViewModel架构</strong></h2><p><strong>优化1：使用单例模式（方法一）</strong></p>
<p>对于WordDatabase，我们通常只需要一个实例，否则在多线程使用这个类的时候，会出现数据上的冲突，因此我们需要提供一个方法来获取唯一的WordDatabase实例。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WordDatabase INSTANCE;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">synchronized</span> WordDatabase <span class="title function_">getInstance</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">        INSTANCE = Room.databaseBuilder(context, WordDatabase.class, <span class="string">&quot;WORD&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码里面，我们还是用了线程同步机制<code>synchronized</code>关键词，使得需要使用该实例的代码进入排队，避免了资源的抢夺。</p>
<p><strong>方法二（更推荐）</strong></p>
<p>该方法下，我们将主构造函数修改为私有的，仅供类中调用，并且提供了两个函数，分别为初始化和获取的函数。并且也只有在第一次调用初始化函数时才会创建对象。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CrimeRepository</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(context: Context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> INSTANCE: CrimeRepository? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">initialize</span><span class="params">(context: <span class="type">Context</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">                INSTANCE = CrimeRepository(context)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">()</span></span>: CrimeRepository &#123;</span><br><span class="line">            <span class="keyword">return</span> INSTANCE ?: <span class="keyword">throw</span> IllegalAccessException(<span class="string">&quot;CrimeRepository must be initialized&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们将其放在Application的子类中进行初始化，这样就保证了只会自动进行一次初始化</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CriminalIntentApplication</span> : <span class="type">Application</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        CrimeRepository.initialize(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>优化2：使用LiveData</strong></p>
<p>对于需要显示到界面上的数据，使用LiveData，避免了每次修改数据后，都去呼叫控件的setText方法。而是使用了观察者模式，当数据改变的时候，Room会去通知LiveData数据发生了改变，由于Room和LiveData的集成，因此当我们修改数据库数据的时候，Room会去通知所有的LiveData。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wordViewModel.getAllListLiveDataWords().observe(<span class="built_in">this</span>, words -&gt; &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (Word word : words) &#123;</span><br><span class="line">        text.append(word.toString());</span><br><span class="line">        text.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    data.setText(text.toString());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>优化3：使用异步任务AsyncTask（方法一）</strong></p>
<p>对于数据库操作这种耗时的操作，通常是不允许在主线程，也就是UI线程上执行，因为在UI线程上执行可能会导致用户界面卡顿，甚至程序无响应崩溃，如果一定需要在UI线程上执行数据库操作，需要在构建DataBase实例的时候执行<code>.allowMainThreadQueries()</code>方法。</p>
<p>更好的方法是使用异步任务，系统会开启子线程去执行数据库操作，对于AsyncTask的使用以及参数说明，请参考<code>Android First Line Code.md</code>中的第十章的<strong>使用Android提供的AsyncTask</strong>内容</p>
<p>这是一个抽象类，要使用它就需要让一个子类去继承它，继承的时候可以为AsyncTask指定三个泛型参数</p>
<blockquote>
<p><code>Params</code>：执行AsyncTask时需要传入的参数，用于在后台任务中使用</p>
<p><code>Progress</code>：后台任务执行时，需要在页面上显示进度，则使用这里指定的泛型作为当前进度单位</p>
<p><code>Result</code>：当任务执行完毕时，如果需要对结果进行返回，则使用这里指定的泛型作为返回值类型</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InsertAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">    WordDao wordDao;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InsertAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        wordDao.insertWord(words);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UpdateAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteByIdAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteAllAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LiveData&lt;List&lt;Word&gt;&gt; allListLiveDataWords;</code>之所以不使用异步任务，是因为在Android中，LiveData的底层已经为我们实现了异步任务。</p>
<p><strong>方法二 使用LiveData异步获取数据</strong></p>
<p>Room是原生支持LiveData的，也就是说Room 框架对于返回 LiveData 的查询会自动在后台线程上执行。这是因为 LiveData 的设计目标之一是在异步任务完成后通知观察者，而 Room 利用了 LiveData 的这个特性。</p>
<p>比如Dao有如下接口</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(<span class="string">&quot;SELECT * FROM crime&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getCrimes</span><span class="params">()</span></span>: LiveData&lt;List&lt;Crime&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>仓库层接口如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getCrimes</span><span class="params">()</span></span>: LiveData&lt;List&lt;Crime&gt;&gt; = crimeDao.getCrimes()</span><br></pre></td></tr></table></figure>

<p>ViewModel层接口如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> crimeRepository = CrimeRepository.<span class="keyword">get</span>()</span><br><span class="line"><span class="keyword">val</span> crimeListLiveData = crimeRepository.getCrimes()</span><br></pre></td></tr></table></figure>

<p>那么我们可以直接对LiveData添加观察</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">    crimeListViewModel.crimeListLiveData.observe(viewLifecycleOwner, Observer &#123; crimes -&gt;</span><br><span class="line">        crimes?.let &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Got crimes <span class="subst">$&#123;crimes.size&#125;</span>&quot;</span>)</span><br><span class="line">            updateUI(crimes)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateUI</span><span class="params">(crimes: <span class="type">List</span>&lt;<span class="type">Crime</span>&gt;)</span></span> &#123;</span><br><span class="line">    adapter = CrimeAdapter(crimes)</span><br><span class="line">    binding.crimeRecyclerView.adapter = adapter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方法三：使用executor</strong></p>
<p><a href="./Android%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9">参见Android基础知识点中使用executor</a></p>
<p><strong>优化4：使用ViewModel</strong></p>
<p>通常在Activity中，我们不在里面处理数据，更好的做法是将数据存放在ViewModel中，因此我们将activity中的数据处理转移到了ViewModel中进行统一的管理，并且使用了ViewModel后，对于设备发生屏幕旋转、处于后台时由于内存不足等问题被系统销毁等，在activity重新created后，数据不丢失。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordViewModel</span> <span class="keyword">extends</span> <span class="title class_">AndroidViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    WordDatabase wordDatabase;</span><br><span class="line">    WordDao wordDao;</span><br><span class="line">    LiveData&lt;List&lt;Word&gt;&gt; allListLiveDataWords;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordViewModel</span><span class="params">(<span class="meta">@NonNull</span> Application application)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(application);</span><br><span class="line">        wordDatabase = WordDatabase.getInstance(application);</span><br><span class="line">        wordDao = wordDatabase.getWordDao();</span><br><span class="line">        allListLiveDataWords = wordDao.queryAllWordToLiveData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;Word&gt;&gt; <span class="title function_">getAllListLiveDataWords</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> allListLiveDataWords;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertWords</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InsertAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateWords</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">UpdateAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteAllWords</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DeleteAllAsyncTask</span>(wordDao).execute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteWordsById</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DeleteByIdAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InsertAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">        WordDao wordDao;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">InsertAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">            wordDao.insertWord(words);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UpdateAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">        WordDao wordDao;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">UpdateAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">            wordDao.updateWord(words);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteByIdAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">        WordDao wordDao;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DeleteByIdAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">            wordDao.deleteWord(words);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteAllAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">        WordDao wordDao;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DeleteAllAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... voids)</span> &#123;</span><br><span class="line">            wordDao.deleteAll();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面，由于需要使用application，因此我们使用了ViewModel的子类<code>AndroidViewModel</code>，在这个类的构造方法中，会有一个application，在创建WordDatabase的时候需要使用到这个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wordDatabase = WordDatabase.getInstance(application);</span><br></pre></td></tr></table></figure>

<p>并且为了方便使用内部类中的方法，我们还包装了4个接口，用于被其他类调用。</p>
<p><strong>优化5：分离ViewModel中的数据和数据操作</strong></p>
<p>对于ViewModel，我们应该只让他管理数据，而不是进行数据操作，因此需要用的Room中的Repository的概念，将数据操作存放在仓库中，再由ViewModel去调用仓库类中的数据操作的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordRepository</span> &#123;</span><br><span class="line">    WordDatabase wordDatabase;</span><br><span class="line">    WordDao wordDao;</span><br><span class="line">    LiveData&lt;List&lt;Word&gt;&gt; allListLiveDataWords;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordRepository</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        wordDatabase = WordDatabase.getInstance(context);</span><br><span class="line">        wordDao = wordDatabase.getWordDao();</span><br><span class="line">        allListLiveDataWords = wordDao.queryAllWordToLiveData();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;Word&gt;&gt; <span class="title function_">getAllListLiveDataWords</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> allListLiveDataWords;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertWords</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InsertAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateWords</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">UpdateAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteAllWords</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DeleteAllAsyncTask</span>(wordDao).execute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteWordsById</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DeleteByIdAsyncTask</span>(wordDao).execute(words);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InsertAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">        WordDao wordDao;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">InsertAsyncTask</span><span class="params">(WordDao wordDao)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.wordDao = wordDao;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Word... words)</span> &#123;</span><br><span class="line">            wordDao.insertWord(words);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UpdateAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteByIdAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Word, Void, Void&gt; &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DeleteAllAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="解决Schema警告"><a href="#解决Schema警告" class="headerlink" title="解决Schema警告"></a>解决Schema警告</h2><p>在项目的构建日志中，我们会发现如下的警告信息，提示没有提供schema导出目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warning: Schema export directory is not provided to the annotation processor so we cannot export the schema. You can either provide `room.schemaLocation` annotation processor argument OR set exportSchema to false</span><br></pre></td></tr></table></figure>

<p>数据库schema就是数据库结构，其包含的主要元素有：数据库里有哪些数据表、这些表里有哪些栏位，以及数据表之间的关系和约束是什么。Room支持导出数据库schema到一个文件。这很有用，因为你可以把它保存在版本控制系统中进行版本历史控制</p>
<p>有两种方法</p>
<ol>
<li><p>提供导出目录</p>
<p>在项目build.gradle.kts文件中给注解<code>room.schemaLocation</code>提供位置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  defaultConfig &#123;</span><br><span class="line">...</span><br><span class="line">      kapt &#123;</span><br><span class="line">          arguments &#123;</span><br><span class="line">              arg(<span class="string">&quot;room.schemaLocation&quot;</span>, <span class="string">&quot;<span class="variable">$projectDir</span>/schemas&quot;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其他做法可以参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41886129/article/details/124111081">Android Room 报 Schema export directory is not provided to the annotation processor so we cannot…_android schema export directory is not provided to-CSDN博客</a></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ksp &#123;</span><br><span class="line">    arg(<span class="string">&quot;room.schemaLocation&quot;</span>, <span class="string">&quot;some/path/goes/here/&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给@Database注解中设置禁用该功能</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [Crime::class], version = 1, exportSchema = true)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>关于room schema文件的其他内容参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/shulianghan/article/details/131048359">【Jetpack】使用 Room Migration 升级数据库并导出 Schema 文件 ( Schema 文件简介 | 生成 Schema 文件配置 | 生成 Schema 文件过程 )_migrate schema-CSDN博客</a></p>
<h2 id="迁移-Room-数据库"><a href="#迁移-Room-数据库" class="headerlink" title="迁移 Room 数据库"></a><strong>迁移 Room 数据库</strong></h2><p>当您在应用中添加和更改功能时，需要修改 Room 实体类和底层数据库表以反映这些更改。如果应用更新更改了数据库架构，那么保留设备内置数据库中已有的用户数据就非常重要。</p>
<p>Room 同时支持以自动和手动方式进行的增量迁移。自动迁移适用于大多数基本架构更改，不过您可能需要针对更复杂的更改手动定义迁移路径。</p>
<p>对于表结构的修改，迁移数据库有以下方法</p>
<p>手动迁移：</p>
<p>方法1：<code>.fallbackToDestructiveMigration()</code>使用这个方法暴力升级，不会保留数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> <span class="keyword">synchronized</span> WordDatabase <span class="title function_">getInstance</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">            INSTANCE = Room.databaseBuilder(context, WordDatabase.class, <span class="string">&quot;WORD&quot;</span>)</span><br><span class="line"><span class="comment">//                    暴力手段，不保留数据直接升级</span></span><br><span class="line">                    .fallbackToDestructiveMigration()</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>方法2：自定义迁移规则，需要使用原生的SQL语句去处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Migration</span> <span class="variable">MIGRATION2_3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Migration</span>(<span class="number">2</span>, <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrate</span><span class="params">(<span class="meta">@NonNull</span> SupportSQLiteDatabase database)</span> &#123;</span><br><span class="line">        database.execSQL(<span class="string">&quot;ALTER TABLE word ADD COLUMN bar_data INTEGER NOT NULL DEFAULT 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除字段 4个步骤</span></span><br><span class="line"><span class="comment"> * 1.创建一个新的表</span></span><br><span class="line"><span class="comment"> * 2.将原来的表数据复制到新的表</span></span><br><span class="line"><span class="comment"> * 3.删除原来的表</span></span><br><span class="line"><span class="comment"> * 4.将新表重命名为原来的表名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Migration</span> <span class="variable">MIGRATION3_4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Migration</span>(<span class="number">3</span>, <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrate</span><span class="params">(<span class="meta">@NonNull</span> SupportSQLiteDatabase database)</span> &#123;</span><br><span class="line">        database.execSQL(<span class="string">&quot;CREATE TABLE word_temp(id INTEGER PRIMARY KEY NOT NULL, word_english TEXT,&quot;</span> +</span><br><span class="line">                <span class="string">&quot; word_chinese TEXT)&quot;</span>);</span><br><span class="line">        database.execSQL(<span class="string">&quot;INSERT INTO word_temp (id, word_english, word_chinese)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;SELECT id,word_english,word_chinese FROM word&quot;</span>);</span><br><span class="line">        database.execSQL(<span class="string">&quot;DROP TABLE word&quot;</span>);</span><br><span class="line">        database.execSQL(<span class="string">&quot;ALTER TABLE word_temp RENAME to word&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> <span class="keyword">synchronized</span> WordDatabase <span class="title function_">getInstance</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">            INSTANCE = Room.databaseBuilder(context, WordDatabase.class, <span class="string">&quot;WORD&quot;</span>)</span><br><span class="line"><span class="comment">//                    暴力手段，不保留数据直接升级</span></span><br><span class="line"><span class="comment">//                    .fallbackToDestructiveMigration()</span></span><br><span class="line">                    .addMigrations(MIGRATION3_4)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>.addMigrations(MIGRATION3_4)</code>方法并传递迁移规则即可完成迁移</p>
<h1 id="使用BottomNavigation"><a href="#使用BottomNavigation" class="headerlink" title="使用BottomNavigation"></a><strong>使用BottomNavigation</strong></h1><p>使用BottomNavigation需要先添加了一个menu，需要注意这里item的id</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/firstFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/baseline_looks_one_24&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:title</span>=<span class="string">&quot;First&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/secondFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/baseline_looks_two_24&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:title</span>=<span class="string">&quot;Item&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/thirdFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/baseline_looks_3_24&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:title</span>=<span class="string">&quot;third&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在主视图中添加一个BottomNavigation组件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.google.android.material.bottomnavigation.BottomNavigationView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/bottomNavigationView2&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;#FEFAFD&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">&quot;0.0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:menu</span>=<span class="string">&quot;@menu/my_menu&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.fragment.app.FragmentContainerView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragmentContainerView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">&quot;2dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:defaultNavHost</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">&quot;@+id/bottomNavigationView2&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/my_navgragh&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后新建一个gragh文件，将碎片添加进去，但是不要设置导航，并且在gragh文件中的每个fragment的id需要与前面menu的选项id对应。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/my_navgragh&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:startDestination</span>=<span class="string">&quot;@id/firstFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/firstFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.buttonnavigationdemo.FirstFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;旋转&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_first&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/secondFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.buttonnavigationdemo.SecondFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;缩放&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_seconds&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/thirdFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.buttonnavigationdemo.ThirdFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;移动&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_third&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在活动中设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">BottomNavigationView</span> <span class="variable">bottomNavigationView</span> <span class="operator">=</span> findViewById(R.id.bottomNavigationView2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取通过碎片管理器传递碎片视图id，获取Navigation 组件中用于承载导航图的容器</span></span><br><span class="line">        <span class="type">NavHostFragment</span> <span class="variable">navHostFragment</span> <span class="operator">=</span> (NavHostFragment) getSupportFragmentManager().findFragmentById(R.id.fragmentContainerView);</span><br><span class="line">        <span class="comment">// 通过 navHostFragment 获取与导航图相关联的 NavController 对象。</span></span><br><span class="line">        <span class="comment">// NavController 是 Navigation 组件的一部分，用于管理导航操作和目标之间的关系。</span></span><br><span class="line">        <span class="type">NavController</span> <span class="variable">navController</span> <span class="operator">=</span> navHostFragment.getNavController();</span><br><span class="line"><span class="comment">//        由于没有actionBar，因此可以不需要设置appBarConfiguration</span></span><br><span class="line"><span class="comment">//        AppBarConfiguration appBarConfiguration = new AppBarConfiguration.Builder(bottomNavigationView.getMenu()).build();</span></span><br><span class="line"><span class="comment">//        NavigationUI.setupActionBarWithNavController(this, navController, appBarConfiguration);</span></span><br><span class="line">        NavigationUI.setupWithNavController(bottomNavigationView, navController);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用ObjectAnimator对象自定义动画"><a href="#使用ObjectAnimator对象自定义动画" class="headerlink" title="使用ObjectAnimator对象自定义动画"></a><strong>使用ObjectAnimator对象自定义动画</strong></h1><p>使用ObjectAnimator对象，实例化的时候可以设置需要动画的控件，并且设置propertyName，也就是动画类型，比如旋转、缩放、移动等，然后设置起始值和结束值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectAnimator</span> <span class="variable">objectAnimator</span> <span class="operator">=</span> ObjectAnimator.ofFloat(imageView, <span class="string">&quot;x&quot;</span>, <span class="number">0</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>使用setDuration可以设置动画持续时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectAnimator.setDuration(<span class="number">500</span>);</span><br></pre></td></tr></table></figure>

<p>使用setFloadValues这一行代码可以设置属性动画的起始值和结束值，会覆盖实例化设置的值，这个方法允许你动态地设置动画的目标值。</p>
<p>结合ViewModel可以将动画后的值保存</p>
<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ImageView imageView;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span>  inflater.inflate(R.layout.fragment_third, container, <span class="literal">false</span>);</span><br><span class="line">    imageView = view.findViewById(R.id.imageView);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">    mViewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(ThirdViewModel.class);</span><br><span class="line">    imageView.setX(mViewModel.moveDX);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Use the ViewModel</span></span><br><span class="line">    <span class="comment">// 初始化动画对象</span></span><br><span class="line">    <span class="type">ObjectAnimator</span> <span class="variable">objectAnimator</span> <span class="operator">=</span> ObjectAnimator.ofFloat(imageView, <span class="string">&quot;x&quot;</span>, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    objectAnimator.setDuration(<span class="number">500</span>);</span><br><span class="line">    imageView.setOnClickListener(v -&gt; &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextBoolean() ? <span class="number">100</span> : -<span class="number">100</span>;</span><br><span class="line">        objectAnimator.setFloatValues(imageView.getX(), imageView.getX() + dx);</span><br><span class="line">        mViewModel.moveDX += dx;</span><br><span class="line">        objectAnimator.start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_seconds, container, <span class="literal">false</span>);</span><br><span class="line">    imageView = view.findViewById(R.id.imageView);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">    mViewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(SecondViewModel.class);</span><br><span class="line">    imageView.setScaleX(mViewModel.scaleFactor);</span><br><span class="line">    imageView.setScaleY(mViewModel.scaleFactor);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Use the ViewModel</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectAnimator</span> <span class="variable">objectAnimatorX</span> <span class="operator">=</span> ObjectAnimator.ofFloat(imageView, <span class="string">&quot;scaleX&quot;</span>, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="type">ObjectAnimator</span> <span class="variable">objectAnimatorY</span> <span class="operator">=</span> ObjectAnimator.ofFloat(imageView, <span class="string">&quot;scaleY&quot;</span>, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    objectAnimatorX.setDuration(<span class="number">500</span>);</span><br><span class="line">    objectAnimatorY.setDuration(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    imageView.setOnClickListener(v-&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!objectAnimatorX.isRunning()) &#123;</span><br><span class="line">            objectAnimatorX.setFloatValues(imageView.getScaleX(), imageView.getScaleX() + <span class="number">0.1f</span>);</span><br><span class="line">            objectAnimatorY.setFloatValues(imageView.getScaleY(), imageView.getScaleY() + <span class="number">0.1f</span>);</span><br><span class="line">            mViewModel.scaleFactor += <span class="number">0.1</span>;</span><br><span class="line">            objectAnimatorX.start();</span><br><span class="line">            objectAnimatorY.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span>  inflater.inflate(R.layout.fragment_first, container, <span class="literal">false</span>);</span><br><span class="line">    imageView = view.findViewById(R.id.imageView);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">    mViewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(FirstViewModel.class);</span><br><span class="line">    imageView.setRotation(mViewModel.rotation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Use the ViewModel</span></span><br><span class="line">    <span class="comment">// 这一行代码创建了一个 ObjectAnimator 对象，用于对指定视图 imageView 的属性进行动画操作。</span></span><br><span class="line">    <span class="comment">// 具体来说，它会对视图的 &quot;rotation&quot; 属性进行动画操作，从初始值 0（不旋转）到最终值 0（也是不旋转），</span></span><br><span class="line">    <span class="comment">// 这看起来似乎没有实际的旋转效果。如果设置的是0,100那么在点击后会旋转，每次点击都会从0度到100度</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ObjectAnimator</span> <span class="variable">objectAnimator</span> <span class="operator">=</span> ObjectAnimator.ofFloat(imageView, <span class="string">&quot;rotation&quot;</span>, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    objectAnimator.setDuration(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    imageView.setOnClickListener(v -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!objectAnimator.isRunning()) &#123;</span><br><span class="line">            objectAnimator.setFloatValues(imageView.getRotation(), imageView.getRotation() + <span class="number">100</span>);</span><br><span class="line">            mViewModel.rotation += <span class="number">100</span>;</span><br><span class="line">            objectAnimator.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用Paging分页"><a href="#使用Paging分页" class="headerlink" title="使用Paging分页"></a><strong>使用Paging分页</strong></h1><p>Paging 库可帮助您加载和显示来自本地存储或网络中更大的数据集中的数据页面。此方法可让您的应用更高效地利用网络带宽和系统资源。Paging 库的组件旨在契合推荐的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/jetpack/docs/guide?hl=zh-cn">Android 应用架构</a>，流畅集成其他 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/jetpack?hl=zh-cn">Jetpack</a> 组件，并提供一流的 Kotlin 支持。</p>
<p><strong>使用 Paging 库的优势</strong></p>
<p>Paging 库包含以下功能：</p>
<ul>
<li>分页数据的内存中缓存。该功能有助于确保您的应用在处理分页数据时高效使用系统资源。</li>
<li>内置的请求去重功能，可确保您的应用高效利用网络带宽和系统资源。</li>
<li>可配置的 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/recyclerview/widget/RecyclerView?hl=zh-cn"><code>RecyclerView</code></a> 适配器，会在用户滚动到已加载数据的末尾时自动请求数据。</li>
<li>对 Kotlin 协程和数据流以及 <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/androidx/lifecycle/LiveData?hl=zh-cn"><code>LiveData</code></a> 和 RxJava 的一流支持。</li>
<li>内置对错误处理功能的支持，包括刷新和重试功能。</li>
</ul>
<p>导入依赖：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> paging_version = <span class="string">&quot;3.1.1&quot;</span></span><br><span class="line">implementation(<span class="string">&quot;androidx.paging:paging-runtime:<span class="variable">$paging_version</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>由于和RecyclerView配合使用，因此需要一个Adapter，和普通的Adapter不同的地方在于</p>
<blockquote>
<p>需要继承自PagedListAdapter&lt;Student, PagingAdapter.MyViewHolder&gt;</p>
<p>参数一：数据类型</p>
<p>参数2：自定义的ViewHolder</p>
</blockquote>
<p>需要实现的构造方法</p>
<blockquote>
<p>将默认实现的构造方法中的参数移除，在super中创建一个对象，以及两个用于比较的回调方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PagingAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">DiffUtil</span>.ItemCallback&lt;Student&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">areItemsTheSame</span><span class="params">(<span class="meta">@NonNull</span> Student oldItem, <span class="meta">@NonNull</span> Student newItem)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> oldItem.getId() == newItem.getId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">areContentsTheSame</span><span class="params">(<span class="meta">@NonNull</span> Student oldItem, <span class="meta">@NonNull</span> Student newItem)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> oldItem.getStudentNumber() == newItem.getStudentNumber();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>代码如下：</p>
<blockquote>
<p>有个细节，由于分页数量的设置，通过获取position位置上的对象后，如果是null，那么将显示为loading</p>
<pre><code>    Student item = getItem(position);
    if (item == null) &#123;
        holder.textView.setText(&quot;Loading&quot;);
    &#125; else &#123;
        holder.textView.setText(String.valueOf(item.getStudentNumber()));
    &#125;
</code></pre>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PagingAdapter</span> <span class="keyword">extends</span> <span class="title class_">PagedListAdapter</span>&lt;Student, PagingAdapter.MyViewHolder&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PagingAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">DiffUtil</span>.ItemCallback&lt;Student&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">areItemsTheSame</span><span class="params">(<span class="meta">@NonNull</span> Student oldItem, <span class="meta">@NonNull</span> Student newItem)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> oldItem.getId() == newItem.getId();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">areContentsTheSame</span><span class="params">(<span class="meta">@NonNull</span> Student oldItem, <span class="meta">@NonNull</span> Student newItem)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> oldItem.getStudentNumber() == newItem.getStudentNumber();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MyViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(<span class="meta">@NonNull</span> ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> LayoutInflater.from(parent.getContext()).inflate(R.layout.cell, parent, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyViewHolder</span>(view);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(<span class="meta">@NonNull</span> MyViewHolder holder, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">item</span> <span class="operator">=</span> getItem(position);</span><br><span class="line">        <span class="keyword">if</span> (item == <span class="literal">null</span>) &#123;</span><br><span class="line">            holder.textView.setText(<span class="string">&quot;Loading&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            holder.textView.setText(String.valueOf(item.getStudentNumber()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyViewHolder</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.ViewHolder &#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyViewHolder</span><span class="params">(<span class="meta">@NonNull</span> View itemView)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(itemView);</span><br><span class="line">            textView = itemView.findViewById(R.id.textView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Activity中我们创建了一个 LiveData&lt;PagedList<Student>&gt; pagedListLiveData对象，在创建这个对象的时候，我们通过数据库查询</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(&quot;SELECT * FROM student_table ORDER BY ID&quot;)</span></span><br><span class="line">DataSource.Factory&lt;Integer, Student&gt; <span class="title function_">queryAllData</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>返回了一个数据源对象，这个数据源对象将作为第一个参数，第二个参数为分页的加载数量，也就是每次分页的数量，通过build进行构建。再对其设置一个观察者，数据改变的时候，底层数据库会通知这个观察者，然后通过adapter将数据进行提交，完成最新数据的显示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    RecyclerView recyclerView;</span><br><span class="line">    PagingAdapter adapter;</span><br><span class="line">    Button insert, clear;</span><br><span class="line">    StudentDatabase studentDatabase;</span><br><span class="line">    StudentDao studentDao;</span><br><span class="line">    LiveData&lt;PagedList&lt;Student&gt;&gt; pagedListLiveData;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        recyclerView = findViewById(R.id.recyclerView);</span><br><span class="line">        insert = findViewById(R.id.buttonInsert);</span><br><span class="line">        clear = findViewById(R.id.buttonClear);</span><br><span class="line">        adapter = new PagingAdapter();</span><br><span class="line">        recyclerView.setAdapter(adapter);</span><br><span class="line">        recyclerView.setLayoutManager(new LinearLayoutManager(</span><br><span class="line">                this, LinearLayoutManager.VERTICAL, false));</span><br><span class="line">        studentDatabase = StudentDatabase.getInstance(this);</span><br><span class="line">        studentDao = studentDatabase.getStudentDao();</span><br><span class="line"></span><br><span class="line">        pagedListLiveData = new LivePagedListBuilder&lt;&gt;(studentDao.queryAllData(), 20).build();</span><br><span class="line">        pagedListLiveData.observe(this, new Observer&lt;PagedList&lt;Student&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onChanged(PagedList&lt;Student&gt; students) &#123;</span><br><span class="line"></span><br><span class="line">                adapter.submitList(students);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        insert.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            Student[] students = new Student[1000];</span><br><span class="line">            for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">                Student student = new Student(i);</span><br><span class="line">                student.setStudentNumber(i);</span><br><span class="line">                students[i] = student;</span><br><span class="line">            &#125;</span><br><span class="line">            new insertAsyncTask(studentDao).execute(students);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        clear.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            new clearAsyncTask(studentDao).execute();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class insertAsyncTask extends AsyncTask&lt;Student, Void, Void&gt; &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class clearAsyncTask extends AsyncTask&lt;Void, Void, Void&gt; &#123;</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用Serializable序列化和反序列化对象"><a href="#使用Serializable序列化和反序列化对象" class="headerlink" title="使用Serializable序列化和反序列化对象"></a><strong>使用Serializable序列化和反序列化对象</strong></h1><p>对于需要序列化的对象，只需要使其实现Serializable接口即可，如果不想某个属性被序列化，可以在属性前使用transient关键字。</p>
<blockquote>
<p>注意：如果在以后，对象的结构发生了变化，Serializable版本会被更新，会导致之前序列化的内容无法被读取，因此可以设置一个SerializableUID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Serial</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8449296755745138964L</span>;</span><br></pre></td></tr></table></figure>

<p>如果你的对象依赖了其他的类，其他类也需要设置UID，当被读取的时候，未被设置的内容会被置空</p>
</blockquote>
<p>如果需要把对象序列化并输出到文件中，使用ObjectOutputStream类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(openFileOutput(MY_CLASS, MODE_PRIVATE));</span><br><span class="line">objectOutputStream.writeObject(student);</span><br><span class="line">objectOutputStream.flush();</span><br><span class="line">objectOutputStream.close();</span><br></pre></td></tr></table></figure>

<p>如果需要把对象反序列化，并存储到对象中，使用ObjectInputStream类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(openFileInput(MY_CLASS));</span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> (Student)objectInputStream.readObject();</span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MY_CLASS</span> <span class="operator">=</span> <span class="string">&quot;my_class&quot;</span>;</span><br><span class="line">    ActivityMainBinding activityMainBinding;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        activityMainBinding = DataBindingUtil.setContentView(<span class="built_in">this</span>, R.layout.activity_main);</span><br><span class="line">        activityMainBinding.buttonSave.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">math</span> <span class="operator">=</span> Integer.valueOf(activityMainBinding.editTextMath.getText().toString());</span><br><span class="line">            <span class="type">int</span> <span class="variable">chinese</span> <span class="operator">=</span> Integer.valueOf(activityMainBinding.editTextChinese.getText().toString());</span><br><span class="line">            <span class="type">int</span> <span class="variable">english</span> <span class="operator">=</span> Integer.valueOf(activityMainBinding.editTextEnglish.getText().toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> activityMainBinding.editTextName.getText().toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> Integer.parseInt(activityMainBinding.editTextAge.getText().toString());</span><br><span class="line">            <span class="type">Score</span> <span class="variable">score</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Score</span>(math, chinese, english);</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(name, age, score);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(openFileOutput(MY_CLASS, MODE_PRIVATE));</span><br><span class="line">                objectOutputStream.writeObject(student);</span><br><span class="line">                objectOutputStream.flush();</span><br><span class="line">                objectOutputStream.close();</span><br><span class="line">                activityMainBinding.textView.setText(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;onCreate: &quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        activityMainBinding.buttonLoad.setOnClickListener(v -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(openFileInput(MY_CLASS));</span><br><span class="line">                <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> (Student)objectInputStream.readObject();</span><br><span class="line">                activityMainBinding.editTextName.setText(student.getName());</span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;onCreate: &quot;</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用parcelable在进程中传递数据"><a href="#使用parcelable在进程中传递数据" class="headerlink" title="使用parcelable在进程中传递数据"></a><strong>使用parcelable在进程中传递数据</strong></h1><p>使用parcelable，需要在数据类上实现parcelable接口，并且添加四个方法</p>
<blockquote>
<p>分别是构造函数、写入parcel、描述、静态构造者方法（用于将序列化后的内容转换为对象或者对象数据）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">Student</span><span class="params">(Parcel in)</span> &#123;</span><br><span class="line">    name = in.readString();</span><br><span class="line">    score = in.readParcelable(Score.class.getClassLoader());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeToParcel</span><span class="params">(Parcel dest, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    dest.writeString(name);</span><br><span class="line">    dest.writeParcelable(score, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">describeContents</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;Student&gt; CREATOR = <span class="keyword">new</span> <span class="title class_">Creator</span>&lt;Student&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">createFromParcel</span><span class="params">(Parcel in)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Student[] newArray(<span class="type">int</span> size) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>[size];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后通过intent将数据传递到另外的活动进程，最好通过bundle包装一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, MainActivity2.class);</span><br><span class="line"><span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">bundle.putParcelable(<span class="string">&quot;student&quot;</span>, student);</span><br><span class="line">intent.putExtra(<span class="string">&quot;data&quot;</span>, bundle);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>

<p>也可以不使用bundle，直接使用putParcelable传递</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(<span class="string">&quot;student&quot;</span>, student);</span><br></pre></td></tr></table></figure>

<p>如果需要在启动另外一个活动的时候开启另外一个进程，需要在AndroidManifest中修改，添加一个process属性，如果不开启进程，就不算是进程中传递</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity2&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:process2&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">&lt;activity</span><br></pre></td></tr></table></figure>

<p>还有一个使用Application的方法，但是这不利于模块化，首先自定义一个MyApplication，继承自Application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Student student;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在AndroidManifest中将Application设置为自定义的Application</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MyApplication&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span></span></span><br><span class="line"><span class="tag">    <span class="attr">application</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是，由于Application不是跨进程的，因此，如果将另外一个活动设置为开启新进程后，会导致错误，因为不是一个Application了，数据当然就获取不到了，只能在同一进程中使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Application</span> <span class="variable">application</span> <span class="operator">=</span> getApplication();</span><br><span class="line"><span class="type">MyApplication</span> <span class="variable">myApplication</span> <span class="operator">=</span> (MyApplication) application;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyApplication</span> <span class="variable">myApplication</span> <span class="operator">=</span> (MyApplication)getApplication();</span><br><span class="line"><span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> myApplication.student;</span><br></pre></td></tr></table></figure>

<h1 id="使用Volley"><a href="#使用Volley" class="headerlink" title="使用Volley"></a><strong>使用Volley</strong></h1><p><strong>使用Volley进行StringRequest请求</strong></p>
<blockquote>
<p>1.创建一个RequestQueue队列（带有调度程序线程池的请求调度队列。调用add(Request)将使给定的Request排队等待调度，从工作线程上的缓存或网络进行解析，然后在主线程上交付解析后的响应。）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RequestQueue</span> <span class="variable">requestQueue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>2.创建一个StringRequest对象，用于处理字符串请求，需要4个参数</p>
<p>参数1：请求方法</p>
<p>参数2：请求地址</p>
<p>参数3：请求监听对象，回调方法中可以处理响应数据</p>
<p>参数4：请求失败监听对象，回调方法中可以处理出错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringRequest</span> <span class="variable">stringRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRequest</span>(</span><br><span class="line">        Request.Method.GET,</span><br><span class="line">        url,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                textView.setText(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onErrorResponse: &quot;</span> + error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>3.提交任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestQueue.add(stringRequest);</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>使用Volley库进行图片加载</strong></p>
<blockquote>
<p>1.首先需要创建一个ImageLoader，ImageLoader是Volley库中的一个类，用于异步加载网络上的图片并在应用中显示。它提供了简单且高效的图片加载功能</p>
<p>需要提供两个参数</p>
<p>参数1：请求队列</p>
<p>参数2：缓存容器ImageCache，需要实现两个回调方法</p>
<p>​	getBitmap(String url)方法用于从缓存中获取指定URL的Bitmap对象。</p>
<p>​	putBitmap(String url, Bitmap bitmap)方法用于将Bitmap对象存入缓存中。</p>
<p>通过在缓存容器中提供LruCache对象，设置为最大缓存数据为40个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LruCache&lt;String, Bitmap&gt; cache = <span class="keyword">new</span> <span class="title class_">LruCache</span>&lt;&gt;(<span class="number">40</span>);</span><br></pre></td></tr></table></figure>

<p><strong>完整代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">imageLoader = <span class="keyword">new</span> <span class="title class_">ImageLoader</span>(requestQueue, <span class="keyword">new</span> <span class="title class_">ImageLoader</span>.ImageCache() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LruCache&lt;String, Bitmap&gt; cache = <span class="keyword">new</span> <span class="title class_">LruCache</span>&lt;&gt;(<span class="number">40</span>);</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Bitmap <span class="title function_">getBitmap</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache.get(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putBitmap</span><span class="params">(String url, Bitmap bitmap)</span> &#123;</span><br><span class="line">        cache.put(url, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>2.调用上面图片加载器的get方法加载图片，需要两个参数</p>
<p>参数1：图片地址</p>
<p>参数2：图片监听器对象，用于监听图片加载的响应和错误，需要实现两个回调方法</p>
<p>​	onResponse(ImageLoader.ImageContainer response, boolean isImmediate)方法在图片加载成功后被调用。它获取响应中的Bitmap对象，并将其设置到指定的ImageView（imageView）上显示。</p>
<p>​	onErrorResponse(VolleyError error)方法在图片加载发生错误时被调用。它打印错误信息到Logcat中。</p>
<p><strong>完整代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">imageLoader.get(urlImage1, <span class="keyword">new</span> <span class="title class_">ImageLoader</span>.ImageListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(ImageLoader.ImageContainer response, <span class="type">boolean</span> isImmediate)</span> &#123;</span><br><span class="line">        imageView.setImageBitmap(response.getBitmap());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onErrorResponse: &quot;</span> + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>！我们可以不手动调用get方法，将图片的控件修改为NetworkImageView，然后调用networkImageView.setImageUrl(urlImage, imageLoader);这个方法传递图片地址和图片加载器即可完成加载。</p>
</blockquote>
<h1 id="使用Glide完成网络图片的加载"><a href="#使用Glide完成网络图片的加载" class="headerlink" title="使用Glide完成网络图片的加载"></a><strong>使用Glide完成网络图片的加载</strong></h1><blockquote>
<p>Glide的使用非常简单，首先需要使用with方法，传递一个Activity参数，该方法将会把Glide绑定到该Activity的生命周期。</p>
<p>使用load方法将会加载图片，这个参数可以是一个网络地址Url，也可以是一个本地路径</p>
<p>使用placeholder可以设置一个占位符，对于图片没有加载出来的时候，将会使用该占位符去填充容器</p>
<p>使用listener可以设置一个监听器，对于该监听器，可以监听到请求失败和成功，然后在回调方法中进行处理</p>
<p>最后使用into将加载的图片设置到指定的容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="built_in">this</span>)</span><br><span class="line">     .load(url)</span><br><span class="line">     .placeholder(R.drawable.ic_launcher_background)</span><br><span class="line">     .listener(<span class="keyword">new</span> <span class="title class_">RequestListener</span>&lt;Drawable&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLoadFailed</span><span class="params">(<span class="meta">@Nullable</span> GlideException e, <span class="meta">@Nullable</span> Object model, <span class="meta">@NonNull</span> Target&lt;Drawable&gt; target, <span class="type">boolean</span> isFirstResource)</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onResourceReady</span><span class="params">(<span class="meta">@NonNull</span> Drawable resource, <span class="meta">@NonNull</span> Object model, Target&lt;Drawable&gt; target, <span class="meta">@NonNull</span> DataSource dataSource, <span class="type">boolean</span> isFirstResource)</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (swipeRefreshLayout.isRefreshing()) &#123;</span><br><span class="line">                 swipeRefreshLayout.setRefreshing(<span class="literal">false</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     .into(imageView);</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="使用tabLayout和viewPager2实现滑动分页"><a href="#使用tabLayout和viewPager2实现滑动分页" class="headerlink" title="使用tabLayout和viewPager2实现滑动分页"></a><strong>使用tabLayout和viewPager2实现滑动分页</strong></h1><p>首先在布局中添加两个控件，将tabLayout设置到屏幕顶部</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/tabLayout&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:tabIndicatorColor</span>=<span class="string">&quot;#000000&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabItem</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;Monday&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabItem</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;Tuesday&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabItem</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;Wednesday&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.google.android.material.tabs.TabLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">View</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/divider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;1dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;?android:attr/listDivider&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.viewpager2.widget.ViewPager2</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/viewPager2&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.viewpager2.widget.ViewPager2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于viewPager2实际上使用的RecyclerView实现的，因此我们需要为他创建一个适配器，简单起见，使用匿名内部类实现，需要传递页面的数量，然后在createFragment方法中，设置当position等于某个值的时候，使用某个fragment</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_binding.viewPager2.adapter = <span class="keyword">object</span> : FragmentStateAdapter(<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回当前item数量</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFragment</span><span class="params">(position: <span class="type">Int</span>)</span></span>: Fragment &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> (position) &#123;</span><br><span class="line">            <span class="number">0</span> -&gt; ScaleFragment()</span><br><span class="line">            <span class="number">1</span> -&gt; RotateFragment()</span><br><span class="line">            <span class="keyword">else</span> -&gt; TranslateFragment()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后需要创建一个TabLayoutMediator，需要两个参数，分别是tabLayout和viewPager2，用于将它们绑定。以便在TabLayout中显示不同的选项卡，并在ViewPager2中管理不同的页面。根据代码中的逻辑，它会在TabLayout中创建三个选项卡，分别对应缩放、旋转和移动。最后，<code>.attach()</code> 方法用于将TabLayoutMediator与TabLayout和ViewPager2关联，确保选项卡与页面的切换是同步的，用户可以通过点击选项卡来切换到相应的页面，或者通过滑动ViewPager2来实现同样的效果。</p>
<p>20.使用Activity-ktx拓展插件对ViewModel进行实例化</p>
<p>首先需要添加依赖</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;androidx.activity:activity-ktx:1.7.2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后对ViewModel实例化的时候就可以采用如下语法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        val myViewModel = ViewModelProvider(this).get(MyViewModel::class.java)</span></span><br><span class="line"><span class="comment">//        val myViewModel = ViewModelProvider(this, ViewModelProvider.NewInstanceFactory()).get(MyViewModel::class.java)</span></span><br><span class="line">        <span class="keyword">val</span> myViewModel:MyViewModel <span class="keyword">by</span> viewModels()</span><br></pre></td></tr></table></figure>

<h1 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a><strong>MVVM</strong></h1><ol>
<li><strong>Model（模型）：</strong><ul>
<li>模型层代表应用程序的数据和业务逻辑。它负责处理数据的获取、存储、更新和验证。模型不直接与用户界面交互。</li>
</ul>
</li>
<li><strong>View（视图）：</strong><ul>
<li>视图层是用户界面的表示，负责显示数据、接收用户输入，并将用户的操作传递给 ViewModel 处理。在 Android 中，通常是 XML 布局文件定义的视图层。</li>
</ul>
</li>
<li><strong>ViewModel（视图模型）：</strong><ul>
<li>视图模型是连接模型和视图的中间层。它处理视图所需的业务逻辑，将数据从模型转换为视图可以显示的格式，并通过数据绑定机制使视图和模型解耦。视图模型不直接持有对视图的引用，而是通过观察者模式或数据绑定来通知视图的变化。</li>
</ul>
</li>
</ol>
<p><img src="/../../images/JetPack/MVVM.png" alt="MVVM"></p>
<p><img src="/../../images/JetPack/image-20240228210534431.png" alt="image-20240228210534431"></p>
<h1 id="Paging3"><a href="#Paging3" class="headerlink" title="Paging3"></a><strong>Paging3</strong></h1><p><img src="/../../images/JetPack/image-20240109155647994.png" alt="image-20240109155647994"></p>
<p>Paging3和Paging2的使用方式有很大的区别，对于Paging3的使用可以参考郭霖的文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/guolin_blog/article/details/114707250?ops_request_misc=%7B%22request_id%22:%22169586886616800215078004%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=169586886616800215078004&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-114707250-null-null.nonecase&utm_term=paging&spm=1018.2226.3001.4450">Jetpack新成员，Paging3从吐槽到真香_guolin paging3_guolin的博客-CSDN博客</a></p>
<p>首先创建一个PagingSource类，传递一个访问网络的对象。并且使其PagingSource类继承自PagingSource，其泛型需要两个参数</p>
<blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PagingSource&lt;<span class="built_in">Int</span>, PhotoItem&gt;() </span><br></pre></td></tr></table></figure>

<p>参数1：如果需要通过页码来加载分页数据，那么在这里使用Int</p>
<p>参数2：分页加载中，表示每一项数据的类型，这里使用每一张图片的类型PhotoItem</p>
</blockquote>
<blockquote>
<p><strong>然后需要重写该父类的两个方法</strong></p>
</blockquote>
<blockquote>
<p><strong>load(parms: LoadParmas<Int>)</strong></p>
<p>该方法携带一个加载参数，这个参数中可以获取到加载的页面页面key，以及加载的页面大小loadSize，pageSize将会在之后的repostory类中进行设置，page如果没有设置，那么默认是1</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> page = params.key ?: <span class="number">1</span></span><br><span class="line"><span class="keyword">val</span> pageSize = params.loadSize</span><br></pre></td></tr></table></figure>

<p>然后通过传递进来的网络对象进行网络请求，获取数据response，该数据对象中包含了很多项数据，为list类型</p>
<p>然后判断下一页码和前一页码，判断是否还有数据以及是否为首页，然后对页码进行递增递减操作得到前一页和后一页</p>
<p>最后调用LoadResult.Page函数，构建一个LoadResult对象并返回，该函数需要三个参数，分别是解析出来的数据列表、前一页和后一页</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadResult.Page(photoItem, prevKey, nextKey)</span><br></pre></td></tr></table></figure>

<p>详细代码：</p>
<p>在这段代码中，使用协程去处理网络IO，withContext(Dispatchers.IO)表示该代码块将在IO线程池中运行，避免阻塞主线程</p>
<p>然后使用suspendCoroutine，这是一个协程构建起，用于将回调式的异步操作转换为协程的挂起函数</p>
<p>也就是说这段代码是使用协程在后台线程执行网络请求操作，请求完成后，通过协程返回成功的结果或者错误处理</p>
<p>避免了当调用Volley后，由于Volley是异步操作，就会导致主线程的逻辑继续执行，导致主线程中并没有任何请求数据，而且执行了之后的逻辑，最后出错。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">load</span><span class="params">(params: <span class="type">LoadParams</span>&lt;<span class="type">Int</span>&gt;)</span></span>: LoadResult&lt;<span class="built_in">Int</span>, PhotoItem&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> page = params.key ?: <span class="number">1</span></span><br><span class="line">        <span class="keyword">val</span> pageSize = params.loadSize</span><br><span class="line"></span><br><span class="line">        Log.i(<span class="string">&quot;photoItem&quot;</span>, <span class="string">&quot;load: <span class="variable">$page</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> response = withContext(Dispatchers.IO) &#123;</span><br><span class="line">            suspendCoroutine &#123; cont -&gt;</span><br><span class="line">                photoListServiceByVolley.getPhotoItems(page, pageSize, <span class="keyword">object</span> :</span><br><span class="line">                    PhotoListServiceByVolley.PhotoListCallback &#123;</span><br><span class="line">                    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(photoItemResponse: <span class="type">PhotoItemResponse</span>)</span></span> &#123;</span><br><span class="line">                        cont.resume(photoItemResponse)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(errorMessage: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">                        cont.resumeWithException(Exception(errorMessage))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> photoItem = response.items</span><br><span class="line">        Log.e(<span class="string">&quot;photoItem&quot;</span>, <span class="string">&quot;load: <span class="subst">$&#123;photoItem.size&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> prevKey = <span class="keyword">if</span> (page &gt; <span class="number">1</span>) page - <span class="number">1</span> <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">val</span> nextKey = <span class="keyword">if</span> (photoItem.isNotEmpty()) page + <span class="number">1</span> <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">        LoadResult.Page(photoItem, prevKey, nextKey)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        LoadResult.Error(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getRefreshKey()</strong></p>
<p>对于该函数，是比较高级的用法，直接返回null即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getRefreshKey</span><span class="params">(state: <span class="type">PagingState</span>&lt;<span class="type">Int</span>, PhotoItem&gt;)</span></span>: <span class="built_in">Int</span>? = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>创建一个仓库类，用于封装一个Flow流供上层的ViewModel使用</p>
<blockquote>
<p>创建一个Pager对象并返回，需要两个参数</p>
<p>参数1：分页大小</p>
<p>参数2：piagingSourceFactory，需要传递一个PagingSource对象</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Repository</span>(application: Application) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> PAGE_SIZE = <span class="number">30</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> photoListServiceByVolley = PhotoListServiceByVolley(application)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getPagingData</span><span class="params">()</span></span>: Flow&lt;PagingData&lt;PhotoItem&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> Pager(</span><br><span class="line">            config = PagingConfig(PAGE_SIZE),</span><br><span class="line">            pagingSourceFactory = &#123;</span><br><span class="line">                PagingSource(photoListServiceByVolley)</span><br><span class="line">            &#125;</span><br><span class="line">        ).flow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>创建一个ViewModel，该ViewModel继承自AndroidViewModel，因为Volley需要application参数</p>
<blockquote>
<p>在ViewModel中，需要对流数据进行缓存，原因：由于子项数据有点击事件，当通过navigation返回的时候，fragment会重新绘制，而在Fragment的逻辑中会重新获取流数据，导致重新发起网络请求，数据就会发生变化</p>
<p>因此创建一个用于保存流数据的对象，由于ViewModel存在生命周期的，因此在ViewModel中保存了一个flow流对象，用于在第一次创建后，在之后的访问中，可以重复调用该流对象，避免每次fragment重新绘制View后都会得到一个新的流对象</p>
<p>使用<code>cachedIn</code> 对 Flow 进行缓存时，实际上并不会触发数据的收集（collect）操作。<code>cachedIn</code> 用于在 Flow 的数据源上添加缓存，以确保多次收集相同的 Flow 时，数据源不会多次执行，而是返回已经缓存的结果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GalleryViewModel</span>(<span class="keyword">private</span> <span class="keyword">val</span> application: Application) : AndroidViewModel(application) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个用于保存流数据的对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> cachedPagingData: Flow&lt;PagingData&lt;PhotoItem&gt;&gt;? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getPagingData</span><span class="params">()</span></span>: Flow&lt;PagingData&lt;PhotoItem&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (cachedPagingData == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 当流中没有数据的时候，将会执行保存</span></span><br><span class="line">            cachedPagingData = Repository(application).getPagingData().cachedIn(viewModelScope)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回流数据</span></span><br><span class="line">        <span class="keyword">return</span> cachedPagingData!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>fragment中调用</p>
<blockquote>
<p>先获取缓存，如果没有缓存流对象，那么调用getPagingData函数获取一个缓存流对象，然后提交数据</p>
<p>请注意：一定要获取缓存流对象，否则多次调用下面的方法后，将会产生多个独立的缓存流对象，每个调用都会在数据流的操作链上添加一个独立的缓存层。这是使用cachedIn的原因，但是必须调用该函数，才会使得每次使用的都是同一个缓存的结果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cachedPagingData = Repository(application).getPagingData().cachedIn(viewModelScope)</span><br></pre></td></tr></table></figure>

<p><strong>ChatGpt解释</strong>：结合ViewModel和Fragment中的代码</p>
<p>在这段代码中，<code>cachedPagingData</code> 是一个经过缓存的分页数据的 Flow 对象。当您调用 <code>cachedIn(viewModelScope)</code> 时，它会在 Flow 的操作链上添加一个缓存层，以确保在多次收集相同的 Flow 时，不会重复执行数据加载。这个缓存是在 <code>viewModelScope</code> 的生命周期内管理的。</p>
<p>然后，当您再次调用 <code>.cachedIn(viewLifecycleOwner.lifecycleScope)</code> 时，它会添加另一个缓存层，这次是在 <code>viewLifecycleOwner.lifecycleScope</code>（通常是 Fragment 的生命周期范围）内管理的。这意味着您在 <code>Fragment</code> 的生命周期内也对数据进行了缓存。</p>
<p>因此，最终的效果是，数据加载结果会在 <code>viewModelScope</code> 和 <code>viewLifecycleOwner.lifecycleScope</code> 内都被缓存，以便在这两个生命周期范围内多次收集数据时都能够获得缓存的结果，而不会重复加载数据。</p>
<p>总结一下，<code>cachedIn</code> 的作用是为数据流添加缓存，以便在多次收集相同数据流时避免重复加载。在您的代码中，它被两次使用，一次在 <code>viewModelScope</code> 内，一次在 <code>viewLifecycleOwner.lifecycleScope</code> 内，以确保数据在不同生命周期范围内都得到了缓存。这可以提高性能，避免不必要的数据加载。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lifecycleScope.launch &#123;</span><br><span class="line">    (galleryViewModel.cachedPagingData ?: galleryViewModel.getPagingData()).apply &#123;</span><br><span class="line">        <span class="keyword">this</span>.cachedIn(viewLifecycleOwner.lifecycleScope).collect &#123;</span><br><span class="line">            galleryAdapterPaging3.submitData(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="WorkManager"><a href="#WorkManager" class="headerlink" title="WorkManager"></a><strong>WorkManager</strong></h1><p><img src="/../../images/JetPack/image-20240109154326225.png" alt="image-20240109154326225"></p>
<p>WorkManager会根据系统版本自动选择底层使用AlarmManager实现还是JobScheduler（5.0开始）</p>
<h2 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h2><p>主要分为三部分</p>
<ol>
<li><p>定义一个后台任务，并实现具体逻辑</p>
<p>每一个后台任务都需要继承自Worker类，并且实现dowork()方法，该方法不会运行在主线程，最后该方法需要返回一个Result对象，有三种选择</p>
<ul>
<li><strong>Result.success()</strong> 表示成功</li>
<li><strong>Result.failure()</strong> 表示失败</li>
<li><strong>Result.retry()</strong> 表示失败，可重试任务</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWorker</span>(context: Context, workerParams: WorkerParameters) :Worker(context, workerParams) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        Log.i(tag, <span class="string">&quot;doWork in SimpleWorker&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Result.success()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置该后台任务的运行条件和约束信息，并构建后台任务请求</p>
<p><code>OneTimeWorkRequest</code>用于构建单次运行的后台任务</p>
<p><code>PeriodicWorkRequest</code>用于构建周期性任务，但是周期间隔不得低于15分钟</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = OneTimeWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java).build()</span><br><span class="line"><span class="keyword">val</span> request = PeriodicWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java, <span class="number">15</span>, TimeUnit.MINUTES).build()</span><br></pre></td></tr></table></figure>
</li>
<li><p>将该后台任务请求传入WorkManager的enqueue()方法中，系统会在合适的时间执行</p>
<p>获取WorkManager对象后，再调用enqueue即可执行任务</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">binding.doWork.setOnClickListener &#123;</span><br><span class="line">    <span class="keyword">val</span> request = OneTimeWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java).build()</span><br><span class="line">    WorkManager.getInstance(<span class="keyword">this</span>).enqueue(request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>需要注意的是，由于国内手机系统大多数都魔改过，当划掉后台的时候，进程会被杀死。当进程被杀死后，是没有办法执行后台工作的，只有当下次打开应用程序的时候才会执行上次的任务。只有当应用程序拥有后台运行的权限才可以执行工作。</p>
<h2 id="处理复杂任务"><a href="#处理复杂任务" class="headerlink" title="处理复杂任务"></a>处理复杂任务</h2><ol>
<li><p>指定延迟运行<code>setInitialDelay</code>，还可以选择其他时间单位</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = OneTimeWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java)</span><br><span class="line">	.setInitialDelay(<span class="number">5</span>, TimeUnit.MINUTES)</span><br><span class="line">	.build()</span><br></pre></td></tr></table></figure>
</li>
<li><p>给后台任务添加标签<code>addTag</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = OneTimeWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java)</span><br><span class="line">	.addTag(<span class="string">&quot;simple&quot;</span>)</span><br><span class="line">	.build()</span><br></pre></td></tr></table></figure>
</li>
<li><p>取消带有标签的任务<code>cancelWorkById()</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(<span class="keyword">this</span>).cancelWorkById(<span class="string">&quot;simple&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>失败后重试任务<code>setBackoffCriteria()</code></p>
<p>该方法接收3个参数</p>
<ul>
<li><strong>backoffPolicy: BackoffPolicy</strong>：如果任务持续失败，那么下一次任务执行时间进行延迟；可选<code>BackoffPolicy.LINEAR</code>和<code>BackoffPolicy.EXPONENTIAL</code>前者表示重试时间以线性增长，后者为指数增长</li>
<li><strong>backoffDelay: Long</strong>：下次重试任务的延迟</li>
<li><strong>timeUnit: TimeUnit</strong>：时间单位</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = OneTimeWorkRequest.Builder(SimpleWorker::<span class="keyword">class</span>.java)</span><br><span class="line">	.setBackoffCriteria(BackoffPolicy.EXPONENTIAL, <span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">	.build()</span><br></pre></td></tr></table></figure>
</li>
<li><p>监听结果<code>getWorkInfoByIdLiveData</code> <code>getWorkInfoByTagLiveData</code></p>
<p>我们可以通过WorkManager的实例对象通过request请求的id或者tag（一批任务）获取到一个LiveData对象，并对其进行观察</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WorkManager.getInstance(<span class="keyword">this</span>).apply &#123;</span><br><span class="line">    enqueue(request)</span><br><span class="line">    getWorkInfoByIdLiveData(request.id).observe(<span class="keyword">this</span><span class="symbol">@WorkManagerActivity</span>) &#123;workInfo-&gt;</span><br><span class="line">        <span class="keyword">if</span> (workInfo.state == WorkInfo.State.SUCCEEDED) &#123;</span><br><span class="line">            binding.workInfo.text = <span class="string">&quot;任务完成&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workInfo.state == WorkInfo.State.FAILED) &#123;</span><br><span class="line">            binding.workInfo.text = <span class="string">&quot;任务失败&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>链式任务 <code>beginWith()</code> <code>then()</code></p>
<p>我们可以实现一批任务的顺序执行，<code>beginWith()</code>用于开启一个链式任务，<code>then()</code>用于前一个任务运行成功后下一个执行的任务，只要有一个没有运行成功，后面的都不会继续执行</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sync = ...</span><br><span class="line"><span class="keyword">val</span> compress = ...</span><br><span class="line"><span class="keyword">val</span> upload = ...</span><br><span class="line">WorkManager.getInstance(<span class="keyword">this</span>)</span><br><span class="line">	.beginWith(sync)</span><br><span class="line">	.then(compress)</span><br><span class="line">	.then(upload)</span><br><span class="line">	.enqueue()</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加约束条件<code>setConstraints()</code></p>
<p>约束条件用于指定在什么情况下执行工作任务，比如：WLAN、数据流量、网络连接状态、低电量等</p>
<p>创建一个网络连接成功的约束：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建约束条件：当网络连接的时候执行任务</span></span><br><span class="line"><span class="keyword">val</span> constraints =</span><br><span class="line">	Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build()</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> oneTimeWorkRequest = OneTimeWorkRequestBuilder&lt;Worker&gt;()</span><br><span class="line">    .setConstraints(constraints)</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>
</li>
<li><p>传递数据 <code>.setInputData()</code></p>
<p>在创建任务的时候，可以使用<code>.setInputData()</code>传递一个数据给工作者</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oneTimeWorkRequest = OneTimeWorkRequestBuilder&lt;Worker&gt;()</span><br><span class="line">    .setInputData(workDataOf(Pair(WORK_DATA_KEY, WORK_DATA_A_NAME)))</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<p>然后可以在工作者的逻辑中对传递过来的数据进行处理</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Worker</span>(context: Context, workerParams: WorkerParameters) : Worker(context, workerParams) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Result &#123;</span><br><span class="line">        <span class="keyword">val</span> name = <span class="keyword">this</span>.inputData.getString(WORK_DATA_KEY)</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;doWork: Start <span class="variable">$name</span> Work&quot;</span>)</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>)</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;doWork: Work <span class="variable">$name</span> Finish&quot;</span>)</span><br><span class="line">        <span class="comment">// 工作完成，返回完成结果</span></span><br><span class="line">        <span class="keyword">return</span> Result.success(workDataOf(WORK_DATA_KEY_OUTPUT to WORK_DATA_RESULT_NAME))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看见，在工作完成后，我们还返回了数据。对于返回的数据，我们可以对工作任务WorkInfo添加一个观察者，用于观察工作任务的状态，然后对数据进行处理。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">workManager.getWorkInfoByIdLiveData(oneTimeWorkRequest.id).observe(<span class="keyword">this</span>) &#123;</span><br><span class="line">    Log.i(TAG, <span class="string">&quot;onCreate: <span class="subst">$&#123;it.state&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">// 任务完成后，取得返回的数据</span></span><br><span class="line">    <span class="keyword">if</span> (it.state == WorkInfo.State.SUCCEEDED) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;onCreate: <span class="subst">$&#123;it.outputData.getString(WORK_DATA_KEY_OUTPUT)&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://migu316.github.io">migu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://migu316.github.io/2024/01/09/Android/JetPack/">https://migu316.github.io/2024/01/09/Android/JetPack/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migu316.github.io" target="_blank">Migu'Blog|迷毂</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/JecPack/">JecPack</a></div><div class="post_share"><div class="social-share" data-image="http://lc-zp9lZZL0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/09/Android/Android%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="Android疑难杂症"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android疑难杂症</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/06/%E7%BA%BF%E7%B4%A2%E5%8C%96%E4%BA%8C%E5%8F%89%E6%A0%91/" title="线索化二叉树的实现与遍历"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">线索化二叉树的实现与遍历</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/01/09/Android/Android%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="Android疑难杂症"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-09</div><div class="title">Android疑难杂症</div></div></a></div><div><a href="/2024/01/11/Android/Android%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9/" title="Android基础知识点"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-11</div><div class="title">Android基础知识点</div></div></a></div><div><a href="/2024/02/18/Android/Android%E4%BD%BF%E7%94%A8Gradle%E6%89%93%E5%8C%85/" title="Android使用Gradle打包"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-18</div><div class="title">Android使用Gradle打包</div></div></a></div><div><a href="/2024/02/18/Android/SDK%E5%BC%80%E5%8F%91-PermissionX/" title="SDK开发-PermissionX"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-18</div><div class="title">SDK开发-PermissionX</div></div></a></div><div><a href="/2024/02/20/Android/UI/" title="UI"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-20</div><div class="title">UI</div></div></a></div><div><a href="/2024/02/27/Android/Bitmap%E5%9B%BE%E7%89%87%E7%BC%A9%E6%94%BE/" title="Bitmap图片缩放"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-27</div><div class="title">Bitmap图片缩放</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://lc-zp9lZZL0.cn-n1.lcfile.com/EgIh7nP97s2Iva0odX4lINSstzjXQGHa/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">migu</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migu316"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">无~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ViewModel"><span class="toc-number">1.</span> <span class="toc-text">ViewModel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.1.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAViewModel%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">创建ViewModel的几种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ViewModelProvider"><span class="toc-number">1.2.1.</span> <span class="toc-text">使用ViewModelProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91ViewModel%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0-%E4%BD%BF%E7%94%A8ViewModelProvider-Factory"><span class="toc-number">1.2.2.</span> <span class="toc-text">向ViewModel传递参数-使用ViewModelProvider.Factory()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Kotlin%E6%89%A9%E5%B1%95%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.3.</span> <span class="toc-text">使用Kotlin扩展插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ViewModel%E5%A2%9E%E5%BC%BA-%E4%BD%BF%E7%94%A8ViewModel-SavedStateHandle"><span class="toc-number">1.3.</span> <span class="toc-text">ViewModel增强-使用ViewModel SavedStateHandle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ViewModel%E5%AD%90%E7%B1%BB-AndroidViewModel"><span class="toc-number">1.4.</span> <span class="toc-text">ViewModel子类-AndroidViewModel</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LiveData"><span class="toc-number">2.</span> <span class="toc-text">LiveData</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">2.0.1.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map%E5%92%8CswitchMap"><span class="toc-number">2.0.2.</span> <span class="toc-text">map和switchMap</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DataBinding"><span class="toc-number">3.</span> <span class="toc-text">DataBinding</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DataBinding-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.0.1.</span> <span class="toc-text">DataBinding 的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ViewBinding"><span class="toc-number">4.</span> <span class="toc-text">ViewBinding</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewBinding-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">4.0.1.</span> <span class="toc-text">ViewBinding 的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Navigation"><span class="toc-number">5.</span> <span class="toc-text">Navigation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B8%83%E5%B1%80"><span class="toc-number">5.2.</span> <span class="toc-text">创建布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0bar%E6%A0%8F%E7%82%B9%E5%87%BB%E5%9B%BE%E6%A0%87%E8%BF%94%E5%9B%9E"><span class="toc-number">5.3.</span> <span class="toc-text">实现bar栏点击图标返回</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Navigation-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">5.4.</span> <span class="toc-text">Navigation-传递数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Safe-Args%E4%BC%A0%E9%80%92%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">5.4.1.</span> <span class="toc-text">使用Safe Args传递类型安全的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8bundle%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">5.4.2.</span> <span class="toc-text">使用bundle传递数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Navigation-%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE"><span class="toc-number">5.5.</span> <span class="toc-text">Navigation-共享数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Navigation-%E5%BC%80%E5%90%AFactionBar"><span class="toc-number">5.6.</span> <span class="toc-text">Navigation-开启actionBar</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%84%9F%E7%9F%A5%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9FLifeCycles"><span class="toc-number">6.</span> <span class="toc-text">感知生命周期LifeCycles</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%8A%B6%E6%80%81%E4%B8%8E%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">6.0.1.</span> <span class="toc-text">Activity生命周期状态与事件的对应关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Room"><span class="toc-number">7.</span> <span class="toc-text">Room</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">7.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">7.2.</span> <span class="toc-text">基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%85%B6%E4%BB%96%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.2.1.</span> <span class="toc-text">处理其他对象类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Room%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8D%87%E7%BA%A7"><span class="toc-number">7.3.</span> <span class="toc-text">Room数据库升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E8%A1%A8"><span class="toc-number">7.3.1.</span> <span class="toc-text">增加表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">7.3.2.</span> <span class="toc-text">修改表结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9Room%E7%9A%84%E4%BC%98%E5%8C%96-%E4%BD%BF%E7%94%A8ViewModel%E6%9E%B6%E6%9E%84"><span class="toc-number">7.4.</span> <span class="toc-text">对Room的优化-使用ViewModel架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3Schema%E8%AD%A6%E5%91%8A"><span class="toc-number">7.5.</span> <span class="toc-text">解决Schema警告</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%81%E7%A7%BB-Room-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">7.6.</span> <span class="toc-text">迁移 Room 数据库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8BottomNavigation"><span class="toc-number">8.</span> <span class="toc-text">使用BottomNavigation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ObjectAnimator%E5%AF%B9%E8%B1%A1%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A8%E7%94%BB"><span class="toc-number">9.</span> <span class="toc-text">使用ObjectAnimator对象自定义动画</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Paging%E5%88%86%E9%A1%B5"><span class="toc-number">10.</span> <span class="toc-text">使用Paging分页</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Serializable%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E8%B1%A1"><span class="toc-number">11.</span> <span class="toc-text">使用Serializable序列化和反序列化对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8parcelable%E5%9C%A8%E8%BF%9B%E7%A8%8B%E4%B8%AD%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">12.</span> <span class="toc-text">使用parcelable在进程中传递数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Volley"><span class="toc-number">13.</span> <span class="toc-text">使用Volley</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Glide%E5%AE%8C%E6%88%90%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">14.</span> <span class="toc-text">使用Glide完成网络图片的加载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8tabLayout%E5%92%8CviewPager2%E5%AE%9E%E7%8E%B0%E6%BB%91%E5%8A%A8%E5%88%86%E9%A1%B5"><span class="toc-number">15.</span> <span class="toc-text">使用tabLayout和viewPager2实现滑动分页</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MVVM"><span class="toc-number">16.</span> <span class="toc-text">MVVM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Paging3"><span class="toc-number">17.</span> <span class="toc-text">Paging3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WorkManager"><span class="toc-number">18.</span> <span class="toc-text">WorkManager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-1"><span class="toc-number">18.1.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%A4%8D%E6%9D%82%E4%BB%BB%E5%8A%A1"><span class="toc-number">18.2.</span> <span class="toc-text">处理复杂任务</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/07/Android/Glide%E7%9A%84%E4%BC%98%E5%8C%96/" title="使用Glide时的优化">使用Glide时的优化</a><time datetime="2024-05-07T13:03:02.000Z" title="发表于 2024-05-07 21:03:02">2024-05-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/07/Android/ADB%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95/" title="ADB使用命令记录">ADB使用命令记录</a><time datetime="2024-05-07T12:52:59.000Z" title="发表于 2024-05-07 20:52:59">2024-05-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/05/07/Android/RecyclerView%E7%9A%84%E4%BC%98%E5%8C%96/" title="RecyclerView的优化">RecyclerView的优化</a><time datetime="2024-05-07T08:28:02.000Z" title="发表于 2024-05-07 16:28:02">2024-05-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/27/Android/%E8%87%AA%E5%AE%9A%E4%B9%89View/" title="自定义View">自定义View</a><time datetime="2024-04-27T12:59:24.000Z" title="发表于 2024-04-27 20:59:24">2024-04-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/21/Android/RV%E5%B5%8C%E5%A5%97-%E5%A4%84%E7%90%86%E7%A9%BA%E7%99%BD%E5%A4%84%E7%9A%84%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6/" title="RV嵌套-处理空白处的点击事件">RV嵌套-处理空白处的点击事件</a><time datetime="2024-04-21T11:11:22.000Z" title="发表于 2024-04-21 19:11:22">2024-04-21</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By migu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br/>
<span><!--<img src="/img/icp.png" style="padding:0px;margin:0px;vertical-align:middle;">*--><img src="http://lc-zp9lZZL0.cn-n1.lcfile.com/Fr5gRilnGPnM3AgQaFMGISO6k3Y0e3zd/icp.png" style="padding:0px;margin:0px;vertical-align:middle;">
<a href="http://www.beian.gov.cn/"  style="color:#ffffff;padding:0px;margin:0px;vertical-align:middle;" target="_blank">渝ICP备2021011273号-1</a>
</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>